<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Reaction Test</title>

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden}
.menu-btn{
  padding:16px 36px;font-size:18px;font-weight:700;
  border-radius:12px;border:2px solid #1e1e2e;
  background:#14141f;color:#fff;cursor:pointer
}
.menu-btn:hover{border-color:#00e5ff}
#menu{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:16px;z-index:1000
}
#hud{position:fixed;top:16px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333}
.dot.success{background:#00e676;border-color:#00e676}
.dot.fail{background:#ff3d71;border-color:#ff3d71}
#info{position:fixed;bottom:16px;width:100%;text-align:center;font-family:'JetBrains Mono';color:#aaa}
#resultsOverlay{
  position:fixed;inset:0;background:#0a0a0f;
  display:none;z-index:2000;
  padding:40px;overflow:auto
}
#resultsOverlay.show{display:block}
</style>
</head>

<body>

<div id="menu">
  <h1>GK Reaction Test</h1>
  <button class="menu-btn" onclick="startSolo()">Режим 3 — Соло</button>
  <button class="menu-btn" onclick="createDuel()">Режим 4 — Дуэль</button>
</div>

<div id="hud"></div>
<div id="info"></div>

<div id="resultsOverlay"></div>

<script>
/* =====================================================
   DUEL SYSTEM (PeerJS)
===================================================== */
let peer, conn;
let isHost = false;
let duelRounds = [];
let duelIndex = 0;
let myResults = [];
let enemyResults = [];

function createDuel(){
  isHost = true;
  peer = new Peer();
  peer.on('open', id=>{
    const link = location.origin + location.pathname + '?duel=' + id;
    alert('Отправь другу ссылку:\n\n' + link);
  });
  peer.on('connection', c=>{
    conn = c;
    conn.on('open', startDuelAsHost);
    conn.on('data', onMessage);
  });
}

function joinDuel(hostId){
  isHost = false;
  peer = new Peer();
  peer.on('open', ()=>{
    conn = peer.connect(hostId);
    conn.on('data', onMessage);
  });
}

function startDuelAsHost(){
  duelRounds = generateRounds();
  conn.send({type:'INIT', rounds:duelRounds});
  startDuelGame(duelRounds);
}

function onMessage(msg){
  if(msg.type==='INIT'){
    duelRounds = msg.rounds;
    startDuelGame(duelRounds);
  }
  if(msg.type==='RESULTS'){
    enemyResults = msg.results;
    finishCompare();
  }
}

/* =====================================================
   GAME LOGIC
===================================================== */
let attempts = 0;
const MAX = 15;
let currentTarget;
let signalTime;

function generateRounds(){
  const arr=[];
  for(let i=0;i<15;i++){
    arr.push({
      target: randomTarget(),
      delay: Math.random()*1500+600
    });
  }
  return arr;
}

function randomTarget(){
  return ['A','D','W','OUT'][Math.floor(Math.random()*4)];
}

function startDuelGame(rounds){
  document.getElementById('menu').style.display='none';
  attempts=0;
  myResults=[];
  duelIndex=0;
  buildHud();
  startRound();
}

function startRound(){
  if(attempts>=MAX){
    sendResults();
    return;
  }
  const r = duelRounds[duelIndex];
  currentTarget = r.target;
  document.getElementById('info').textContent='Раунд '+(attempts+1);
  setTimeout(()=>{
    signalTime = performance.now();
  }, r.delay);
}

document.addEventListener('keydown',e=>{
  if(!signalTime)return;
  if(e.code==='Space'){
    const rt = Math.round(performance.now()-signalTime);
    const ok = currentTarget!=='OUT';
    myResults.push({ok,reaction:ok?rt:null});
    mark(ok);
    attempts++;duelIndex++;
    signalTime=null;
    setTimeout(startRound,600);
  }
});

function mark(ok){
  document.getElementById('dot'+attempts).className='dot '+(ok?'success':'fail');
}

function buildHud(){
  let h='';
  for(let i=0;i<MAX;i++)h+=`<div class="dot" id="dot${i}"></div>`;
  document.getElementById('hud').innerHTML=h;
}

/* =====================================================
   RESULTS
===================================================== */
function sendResults(){
  conn.send({type:'RESULTS',results:myResults});
  if(enemyResults.length)finishCompare();
}

function finishCompare(){
  const res = compare(myResults,enemyResults);
  const o = document.getElementById('resultsOverlay');
  o.classList.add('show');
  o.innerHTML = `
    <h2>Дуэль завершена</h2>
    <p>Ты: ${res.me} · Соперник: ${res.enemy}</p>
    <h1>${res.me>res.enemy?'ПОБЕДА':'ПОРАЖЕНИЕ'}</h1>
    <button onclick="location.reload()">В меню</button>
  `;
}

function compare(a,b){
  let me=0,enemy=0;
  for(let i=0;i<15;i++){
    const A=a[i],B=b[i];
    if(A.ok&&!B.ok)me++;
    else if(!A.ok&&B.ok)enemy++;
    else if(A.ok&&B.ok){
      if(A.reaction<B.reaction)me++;
      else if(B.reaction<A.reaction)enemy++;
    }
  }
  return {me,enemy};
}

/* =====================================================
   SOLO MODE
===================================================== */
function startSolo(){
  duelRounds = generateRounds();
  startDuelGame(duelRounds);
}

/* =====================================================
   AUTO JOIN FROM LINK
===================================================== */
const q = new URLSearchParams(location.search);
if(q.get('duel')) joinDuel(q.get('duel'));
</script>

</body>
</html>

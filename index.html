<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rematch GK Reaction Test + Duel</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{ --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f; --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00; }

#menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:1000}
#menu h1{font-size:42px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu p{color:#888;font-size:14px;max-width:420px;text-align:center;line-height:1.6}

.menu-btn{ padding:16px 36px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700; border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff; cursor:pointer;transition:all .2s;min-width:280px; }
.menu-btn:hover{border-color:var(--accent);box-shadow:0 0 24px rgba(0,229,255,.15);transform:translateY(-2px)}
.menu-btn span{color:#888;font-weight:300;font-size:14px;display:block;margin-top:4px}

#gameArea{flex:1;display:flex;position:relative;overflow:hidden}
.side{flex:1;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;font-family:'JetBrains Mono',monospace;opacity:.06;transition:all .15s;user-select:none;letter-spacing:4px}
.side.active{opacity:1;color:#000}
#left.active{background:var(--accent)}
#right.active{background:var(--accent)}
#ball{position:absolute;width:36px;height:36px;border-radius:50%;background:#fff;left:50%;top:0%;transform:translate(-50%,0%);display:none;box-shadow:0 0 20px rgba(255,255,255,.5);z-index:10}

/* HUD –∏ –æ—á–∫–∏ –¥—É—ç–ª–∏ */
#hudWrapper{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:50;display:flex;flex-direction:column;align-items:center;gap:10px;max-width:90vw}
#duelScore{display:none; font-family:'JetBrains Mono',monospace; font-size:24px; font-weight:900; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:8px; border:1px solid var(--accent);}
#hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}

.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333;transition:all .3s}
.dot.success{background:var(--success);border-color:var(--success);box-shadow:0 0 8px var(--success)}
.dot.fail{background:var(--fail);border-color:var(--fail);box-shadow:0 0 8px var(--fail)}
.dot.current{border-color:var(--accent);box-shadow:0 0 8px var(--accent)}
.dot.draw{background:var(--warn);border-color:var(--warn);opacity:0.7;}

#info{position:fixed;bottom:16px;width:100%;text-align:center;font-size:16px;font-family:'JetBrains Mono',monospace;color:#888;z-index:50;pointer-events:none}
#resultsOverlay{position:fixed;inset:0;background:rgba(10,10,15,.97);z-index:2000;display:none;flex-direction:column;align-items:center;overflow-y:auto;padding:40px 20px}
#resultsOverlay.show{display:flex}
#resultsContent{max-width:720px;width:100%}
.res-title{font-size:36px;font-weight:900;text-align:center;margin-bottom:8px;letter-spacing:-1px}
.res-avg{text-align:center;font-size:20px;color:var(--accent);font-family:'JetBrains Mono',monospace;margin-bottom:32px}
.round-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:16px}
.round-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:4px}
.round-num{font-weight:700;font-size:14px;color:#888}
.round-result{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.round-result.ok{color:var(--success)}
.round-result.err{color:var(--fail)}
.timeline-wrap{position:relative;height:64px;background:#0d0d18;border-radius:8px;overflow:hidden;border:1px solid #1a1a2a}
.tl-axis{position:absolute;top:50%;left:0;right:0;height:1px;background:#222}
.tl-signal-line{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,255,255,.25);z-index:2}
.tl-label{position:absolute;bottom:2px;font-size:9px;font-family:'JetBrains Mono',monospace;color:#555;z-index:3;transform:translateX(-50%)}
.tl-label.top{bottom:auto;top:2px}
.tl-bar{position:absolute;height:10px;border-radius:3px;z-index:4;opacity:.85;min-width:3px}
.tl-bar.key-a{background:var(--accent)}
.tl-bar.key-d{background:var(--purple)}
.tl-bar.key-w{background:var(--success)}
.tl-marker{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;transform:translate(-50%,-50%);z-index:6}
.tl-marker.signal-mk{background:#fff;box-shadow:0 0 8px #fff}
.tl-marker.space-mk{background:var(--warn);box-shadow:0 0 6px var(--warn)}
.tl-prezone{position:absolute;top:0;bottom:0;background:rgba(255,255,255,.03);z-index:1;border-right:1px dashed rgba(255,255,255,.12)}
.btn-row{display:flex;flex-direction:column;align-items:center;margin-top:32px;gap:10px;padding-bottom:40px}
.restart-btn{ padding:16px 48px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700; border:2px solid var(--accent);border-radius:12px;background:transparent;color:var(--accent); cursor:pointer;transition:all .2s; }
.restart-btn:hover{background:var(--accent);color:#000}
.back-btn{ padding:12px 32px;font-size:14px;font-family:'Outfit',sans-serif;font-weight:500; border:1px solid var(--border);border-radius:8px;background:transparent;color:#888; cursor:pointer;transition:all .2s; }
.back-btn:hover{border-color:#888;color:#fff}

/* MODE 3 */
#mode3Area{position:fixed;inset:0;display:none;overflow:hidden;z-index:40}
#mode3Canvas{width:100%;height:100%;display:block}
.sliderRow{ margin-bottom:16px; }
.sliderRow label{ display:flex; justify-content:space-between; margin-bottom:6px; font-size:14px; color:#aaa; }
.sliderRow input{ width:100%; }

/* DUEL LOBBY */
#duelLobby{
    position:fixed; inset:0; z-index:1600; background:var(--bg);
    display:none; flex-direction:column; align-items:center; justify-content:center;
}
.lobby-card{
    background:var(--card); border:1px solid var(--border); border-radius:16px; padding:32px;
    width:500px; max-width:95vw; text-align:center;
}
#duelLinkInput{
    width:100%; padding:12px; margin:16px 0; background:#0a0a0f; border:1px solid var(--border);
    color:var(--accent); font-family:'JetBrains Mono', monospace; font-size:14px; border-radius:8px;
}
.duel-status{ margin: 20px 0; font-weight:bold; color: var(--warn); min-height: 24px;}
</style>
</head>

<body>

<div id="mode3Settings" style="position:fixed;inset:0;z-index:1500;background:rgba(10,10,15,.97);display:none;align-items:center;justify-content:center;">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;width:420px;max-width:90vw;">
        <h2 style="font-size:28px;margin-bottom:16px">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞—Ä–æ–≤ (–°–æ–ª–æ)</h2>
        <div class="sliderRow"><label>–ú–∏–º–æ –≤–æ—Ä–æ—Ç: <b><span id="pOut">30</span>%</b></label><input type="range" min="0" max="100" value="30" id="outRange"></div>
        <div class="sliderRow"><label>–í —Å—Ç–≤–æ—Ä (—É–≥–ª—ã): <b><span id="pSide">50</span>%</b></label><input type="range" min="0" max="100" value="50" id="sideRange"></div>
        <div class="sliderRow"><label>–ü–æ —Ü–µ–Ω—Ç—Ä—É: <b><span id="pCenter">20</span>%</b></label><input type="range" min="0" max="100" value="20" id="centerRange"></div>
        <button class="menu-btn" style="margin-top:20px" id="startMode3">–û–ö <span>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∂–∏–º</span></button>
    </div>
</div>

<div id="duelLobby">
    <div class="lobby-card" id="lobbyHost" style="display:none;">
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –¥—É—ç–ª–∏ 1x1</h2>
        <p>–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –∏ –æ—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É. –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –æ–Ω –∑–∞–π–¥–µ—Ç –ø–æ –Ω–µ–π.</p>
        <input type="text" id="duelLinkInput" readonly onclick="this.select()">
        <div class="duel-status" id="hostStatus">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏...</div>
         <button class="back-btn" onclick="exitDuelLobby()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div class="lobby-card" id="lobbyJoin" style="display:none;">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—É—ç–ª–∏...</h2>
        <div class="duel-status" id="joinStatus">–ò—â–µ–º –∫–æ–º–Ω–∞—Ç—É...</div>
    </div>
</div>

<div id="menu">
    <h1>GK Reaction Test</h1>
    <p>–ù–∞–∂–º–∏ <b>A</b> –∏–ª–∏ <b>D</b> —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω—É, –∑–∞—Ç–µ–º <b>SPACE</b> —á—Ç–æ–±—ã –ø—Ä—ã–≥–Ω—É—Ç—å. –í —Ä–µ–∂–∏–º–µ 3D –∏—Å–ø–æ–ª—å–∑—É–π <b>W</b> –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞.</p>
    <button class="menu-btn" id="mode1">–†–µ–∂–∏–º 1 ‚Äî –°–∏–≥–Ω–∞–ª<span>–°—Ç–æ—Ä–æ–Ω–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç—Å—è</span></button>
    <button class="menu-btn" id="mode2">–†–µ–∂–∏–º 2 ‚Äî –ú—è—á<span>–ú—è—á –ª–µ—Ç–∏—Ç –≤ —É–≥–æ–ª</span></button>
    <button class="menu-btn" id="mode3btn">–†–µ–∂–∏–º 3 ‚Äî –í–æ—Ä–æ—Ç–∞ 3D (–°–æ–ª–æ)<span>–ú—è—á –ª–µ—Ç–∏—Ç –Ω–∞ —Ç–µ–±—è ¬∑ 15 —Ä–∞—É–Ω–¥–æ–≤</span></button>
    <button class="menu-btn" id="mode4btn" style="border-color:var(--purple)">–†–µ–∂–∏–º 4 ‚Äî –î—É—ç–ª—å 1x1<span>–û–Ω–ª–∞–π–Ω ¬∑ 15 —Ä–∞—É–Ω–¥–æ–≤</span></button>
</div>

<div id="hudWrapper">
    <div id="duelScore"><span style="color:var(--accent)">YOU</span> 0 : 0 <span style="color:var(--fail)">OPP</span></div>
    <div id="hud"></div>
</div>

<div id="gameArea">
    <div id="left" class="side">A</div>
    <div id="right" class="side">D</div>
    <div id="ball"></div>
</div>

<div id="info"></div>

<div id="mode3Area">
    <canvas id="mode3Canvas"></canvas>
</div>

<div id="resultsOverlay">
    <div id="resultsContent"></div>
</div>

<script>
let mode3Chances = { out: 30, side: 50, center: 20 };
const $=id=>document.getElementById(id);
let mode=1,attempts=0,maxAttempts=5;
let target=null,signalTime=0;
let waiting=false,recording=false;
let roundStartTime=0;
let firstDir=null,firstDirTime=null;
let spaceTime=null;
let allKeyDowns={};
let allKeySegments=[];
let allSpacePresses=[];
let roundData=[];
let reactions=[];
const tolerance=20;
let roundNeedsSpace=false;

// --- DUEL GLOBAL VARIABLES ---
const Duel = {
    active: false,
    peer: null,
    conn: null,
    isHost: false,
    roundsTotal: 15,
    targets: [],
    currentRoundData: null,
    opponentRoundData: null,
    myScore: 0,
    oppScore: 0,
    opponentReactions: []
};

// --- INIT ---
function init() {
    const urlParams = new URLSearchParams(window.location.search);
    const duelId = urlParams.get('duel');
    if (duelId) {
        joinDuel(duelId);
    }
}

// --- GAME CONTROL ---
function resetGame(){
    attempts=0;roundData=[];reactions=[];
    $('hud').innerHTML='';$('info').textContent='';
    $('resultsOverlay').classList.remove('show');
    $('left').classList.remove('active');$('right').classList.remove('active');
    $('ball').style.display='none';
    recording=false;waiting=false;
    if(!Duel.active) {
       $('duelScore').style.display = 'none';
    } else {
        $('duelScore').style.display = 'block';
        updateDuelScoreUI();
    }
    buildHud();
}

function buildHud(){
    let h='';for(let i=0;i<maxAttempts;i++) h+=`<div class="dot" id="dot${i}"></div>`;
    $('hud').innerHTML=h;
}

function startGame(m){
    mode=m;
    maxAttempts = (mode===3 || mode===4) ? 15 : 5;
    $('menu').style.display='none';
    if(mode===3 || mode===4){
        $('gameArea').style.display='none';
        $('mode3Area').style.display='block';
        initMode3Canvas();
        if(mode===3) applyMode3Settings();
    } else {
        $('gameArea').style.display='flex';
        $('mode3Area').style.display='none';
    }
    resetGame();
    if(mode !== 4) startRound();
}

$('mode1').onclick=()=>startGame(1);
$('mode2').onclick=()=>startGame(2);
$('mode3btn').onclick=()=>{
    $('menu').style.display='none';
    $('mode3Settings').style.display='flex';
};
$('mode4btn').onclick=()=>hostDuel();

$('outRange').oninput=function(){$('pOut').textContent=this.value;};
$('sideRange').oninput=function(){$('pSide').textContent=this.value;};
$('centerRange').oninput=function(){$('pCenter').textContent=this.value;};
function applyMode3Settings(){
    mode3Chances.out = parseInt($('outRange').value);
    mode3Chances.side = parseInt($('sideRange').value);
    mode3Chances.center = parseInt($('centerRange').value);
}
$('startMode3').onclick=()=>{
    $('mode3Settings').style.display='none';
    startGame(3);
};


// ===================== DUEL NETWORKING =====================
function initPeer(callback) {
    if(Duel.peer) { if(callback) callback(Duel.peer.id); return; }
    Duel.peer = new Peer();
    Duel.peer.on('open', (id) => {
        console.log('My Peer ID is: ' + id);
        if(callback) callback(id);
    });
    Duel.peer.on('connection', (conn) => {
        handleConnection(conn);
    });
    Duel.peer.on('error', (err) => {
        console.error(err);
        alert('–û—à–∏–±–∫–∞ PeerJS: ' + err.type);
        exitDuelLobby();
    });
}

function hostDuel() {
    $('menu').style.display='none';
    $('#duelLobby').style.display='flex';
    $('#lobbyHost').style.display='block';
    $('#hostStatus').textContent = "–ü–æ–ª—É—á–µ–Ω–∏–µ ID...";

    Duel.isHost = true;
    initPeer((id) => {
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
        const link = `${window.location.origin}${window.location.pathname}?duel=${id}`;
        $('duelLinkInput').value = link;
        $('#hostStatus').textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
        
        // –ê–≤—Ç–æ-–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        navigator.clipboard.writeText(link).catch(()=>{});
    });
}

function joinDuel(hostId) {
    $('menu').style.display='none';
    $('#duelLobby').style.display='flex';
    $('#lobbyHost').style.display='none';
    $('#lobbyJoin').style.display='block';

    Duel.isHost = false;
    initPeer(() => {
        const conn = Duel.peer.connect(hostId);
        handleConnection(conn);
    });
}

function handleConnection(conn) {
    Duel.conn = conn;
    Duel.active = true;

    conn.on('open', () => {
        if(Duel.isHost) {
            $('#hostStatus').textContent = "–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω! –°—Ç–∞—Ä—Ç...";
            Duel.targets = generateDuelTargets(Duel.roundsTotal);
            conn.send({ type: 'GAME_START', targets: Duel.targets });
            setTimeout(() => {
                $('#duelLobby').style.display='none';
                startGame(4);
                startDuelRoundProcess();
            }, 1000);
        } else {
            $('#joinStatus').textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ñ–¥–µ–º —Ö–æ—Å—Ç–∞...";
        }
    });

    conn.on('data', (data) => {
        handleIncomingData(data);
    });
     conn.on('close', () => {
        alert("–°–æ–ø–µ—Ä–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è");
        backToMenu();
    });
}

function handleIncomingData(data) {
    switch(data.type) {
        case 'GAME_START':
            if(!Duel.isHost) {
                 Duel.targets = data.targets;
                 $('#duelLobby').style.display='none';
                 startGame(4);
                 startDuelRoundProcess();
            }
            break;
        case 'ROUND_RESULT':
            Duel.opponentRoundData = data.result;
            checkDuelRoundComplete();
            break;
    }
}

function exitDuelLobby() {
    if(Duel.peer) { Duel.peer.destroy(); Duel.peer = null; }
    Duel.active = false;
    $('#duelLobby').style.display='none';
    $('#lobbyHost').style.display='none';
    $('#lobbyJoin').style.display='none';
    $('menu').style.display='flex';
    window.history.replaceState({}, document.title, window.location.pathname);
}

function generateDuelTargets(count) {
    const targets = [];
    const types = ['A', 'D', 'W', 'OUT_TOP', 'OUT_LEFT', 'OUT_RIGHT'];
    for(let i=0; i<count; i++) {
         targets.push(types[Math.floor(Math.random() * types.length)]);
    }
    return targets;
}

// ===================== CANVAS & 3D =====================
const M3={canvas:null,ctx:null,W:0,H:0};
const stadiumImg = new Image(); stadiumImg.src = 'stadium_bg.png';
function initMode3Canvas(){ M3.canvas=$('mode3Canvas'); M3.ctx=M3.canvas.getContext('2d'); resizeMode3(); window.removeEventListener('resize',resizeMode3); window.addEventListener('resize',resizeMode3); }
function resizeMode3(){ const c=M3.canvas; c.width=window.innerWidth; c.height=window.innerHeight; M3.W=c.width;M3.H=c.height; drawMode3Scene(); }
function getGoalGeometry(){ const W=M3.W,H=M3.H; const cx=W/2; const horizonY=H*0.18; const crossbarY=H*0.28; const crossbarHalf=W*0.450; const postBaseY=H*0.84; const goalHeight=postBaseY-crossbarY; const postBaseHalf=crossbarHalf - Math.tan(5*Math.PI/180)*goalHeight; const depthY=H*0.18; const backTL={x:cx-crossbarHalf-W*0.09, y:crossbarY+depthY}; const backTR={x:cx+crossbarHalf+W*0.09, y:crossbarY+depthY}; const backBL={x:cx-postBaseHalf-W*0.10, y:postBaseY+depthY}; const backBR={x:cx+postBaseHalf+W*0.10, y:postBaseY+depthY}; const depthX=W*0.04; return {cx, tl:{x:cx-crossbarHalf, y:crossbarY}, tr:{x:cx+crossbarHalf, y:crossbarY}, bl:{x:cx-postBaseHalf, y:postBaseY}, br:{x:cx+postBaseHalf, y:postBaseY}, backTL, backTR, backBL, backBR, crossbarY, postBaseY, crossbarHalf, postBaseHalf, goalLineY: postBaseY, horizonY, depthX, depthY }; }
function showIdleBall(){ const g = getGoalGeometry(); idleBall = { x: g.cx, y: g.horizonY + 20, size: 6 }; drawMode3Scene(idleBall); }
function drawMode3Scene(ballPos,impactDot){ const ctx=M3.ctx,W=M3.W,H=M3.H; const g=getGoalGeometry(); if (stadiumImg.complete) { const imgW = stadiumImg.width; const imgH = stadiumImg.height; const scale = Math.max(W / imgW, H / imgH); const drawW = imgW * scale; const drawH = imgH * scale; const x = (W - drawW) / 2; const y = (H - drawH) / 2; ctx.drawImage(stadiumImg, x, y, drawW, drawH); } else { ctx.fillStyle = '#0b0f1a'; ctx.fillRect(0, 0, W, H); } const pw=Math.max(6,W*0.007); ctx.lineCap='round';ctx.lineJoin='round'; if(impactDot){ ctx.save(); ctx.shadowColor='rgba(0,229,255,1)';ctx.shadowBlur=50; ctx.fillStyle='rgba(0,229,255,0.4)'; ctx.beginPath();ctx.arc(impactDot.x,impactDot.y,32,0,Math.PI*2);ctx.fill(); ctx.restore(); ctx.save(); ctx.shadowColor='rgba(0,229,255,0.9)';ctx.shadowBlur=30; ctx.fillStyle='rgba(0,229,255,0.85)'; ctx.beginPath();ctx.arc(impactDot.x,impactDot.y,16,0,Math.PI*2);ctx.fill(); ctx.restore(); ctx.fillStyle='#fff'; ctx.beginPath();ctx.arc(impactDot.x,impactDot.y,7,0,Math.PI*2);ctx.fill(); ctx.strokeStyle='rgba(0,229,255,0.7)';ctx.lineWidth=3; ctx.beginPath();ctx.arc(impactDot.x,impactDot.y,26,0,Math.PI*2);ctx.stroke(); ctx.strokeStyle='rgba(0,229,255,0.3)';ctx.lineWidth=2; ctx.beginPath();ctx.arc(impactDot.x,impactDot.y,38,0,Math.PI*2);ctx.stroke(); ctx.strokeStyle='rgba(255,255,255,0.6)';ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(impactDot.x-20,impactDot.y);ctx.lineTo(impactDot.x+20,impactDot.y); ctx.moveTo(impactDot.x,impactDot.y-20);ctx.lineTo(impactDot.x,impactDot.y+20); ctx.stroke(); } if(ballPos){ const sz=ballPos.size||14; ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.beginPath();ctx.ellipse(ballPos.x,ballPos.y+sz*0.4,sz*0.7,sz*0.2,0,0,Math.PI*2);ctx.fill(); const bg=ctx.createRadialGradient(ballPos.x-sz*0.25,ballPos.y-sz*0.25,sz*0.1,ballPos.x,ballPos.y,sz); bg.addColorStop(0,'#fff');bg.addColorStop(0.6,'#e8e8e8');bg.addColorStop(1,'#aaa'); ctx.fillStyle=bg; ctx.beginPath();ctx.arc(ballPos.x,ballPos.y,sz,0,Math.PI*2);ctx.fill(); ctx.save(); ctx.shadowColor='rgba(255,255,255,0.4)';ctx.shadowBlur=18; ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.beginPath();ctx.arc(ballPos.x,ballPos.y,sz,0,Math.PI*2);ctx.fill(); ctx.restore(); ctx.strokeStyle='rgba(0,0,0,0.1)';ctx.lineWidth=0.8; const ps=sz*0.32; ctx.beginPath(); for(let i=0;i<5;i++){ const a=(i/5)*Math.PI*2-Math.PI/2; const px=ballPos.x+Math.cos(a)*ps; const py=ballPos.y+Math.sin(a)*ps; if(i===0)ctx.moveTo(px,py);else ctx.lineTo(px,py); } ctx.closePath();ctx.stroke(); } }
function getBallTargets(){ const g=getGoalGeometry(); const cx=g.cx; const goalH=g.postBaseY-g.crossbarY; const leftCorner={ x: g.bl.x + (g.br.x-g.bl.x)*0.08, y: g.crossbarY + goalH*0.55 }; const rightCorner={ x: g.br.x - (g.br.x-g.bl.x)*0.08, y: g.crossbarY + goalH*0.55 }; const center={ x: cx, y: g.crossbarY + goalH*0.45 }; const overTop={ x: cx + (Math.random()-0.5)*70, y: g.crossbarY - 25 - Math.random()*30 }; const outLeft={ x: g.bl.x - 35 - Math.random()*50, y: g.crossbarY + goalH*(0.2+Math.random()*0.4) }; const outRight={ x: g.br.x + 35 + Math.random()*50, y: g.crossbarY + goalH*(0.2+Math.random()*0.4) }; return {leftCorner,rightCorner,center,overTop,outLeft,outRight}; }
function getRandomMode3Target(){ const r=Math.random()*100; const {out,side,center}=mode3Chances; if(r<out){ return ['OUT_TOP','OUT_LEFT','OUT_RIGHT'] [Math.floor(Math.random()*3)]; } if(r<out+side){ return Math.random()<0.5?'A':'D'; } return 'W'; }
let m3AnimFrame=null;
function animateBallMode3(targetType,onDone){ const targets=getBallTargets(); const g=getGoalGeometry(); let endPos; let thisNeedsSpace=true; switch(targetType){ case 'A':endPos=targets.leftCorner;break; case 'D':endPos=targets.rightCorner;break; case 'W':endPos=targets.center;break; case 'OUT_TOP':endPos=targets.overTop;thisNeedsSpace=false;break; case 'OUT_LEFT':endPos=targets.outLeft;thisNeedsSpace=false;break; case 'OUT_RIGHT':endPos=targets.outRight;thisNeedsSpace=false;break; } roundNeedsSpace=thisNeedsSpace; const startX=g.cx; const startY=g.horizonY + 20; const startSize=4; const endSize=22; const duration=700; const startT=performance.now(); const showImpact = !thisNeedsSpace; const impactPos = showImpact ? {x:endPos.x, y:endPos.y} : null; function frame(now){ let t=(now-startT)/duration; if(t>1)t=1; const ease=1-Math.pow(1-t,3); const x=startX+(endPos.x-startX)*ease; const y=startY+(endPos.y-startY)*ease; const size=startSize+(endSize-startSize)*ease; drawMode3Scene({x,y,size}, impactPos); if(t<1){ m3AnimFrame=requestAnimationFrame(frame); }else{ if(onDone)onDone(); } } m3AnimFrame=requestAnimationFrame(frame); }
function clearMode3Ball(){ if(m3AnimFrame)cancelAnimationFrame(m3AnimFrame); drawMode3Scene(); }

// ===================== GAME LOGIC =====================
let m3SpacePressed=false;
let m3TimeoutId=null;
let idleBall = null;

function startRound(){
    if(mode === 4) { startDuelRoundProcess(); return; }
    if(attempts>=maxAttempts){showResults();return}
    $('left').classList.remove('active'); $('right').classList.remove('active'); $('ball').style.display = 'none'; $('info').textContent = '';
    firstDir = null; firstDirTime = null; spaceTime = null; allKeySegments = []; allSpacePresses = [];

    if(mode===3){
        clearMode3Ball(); showIdleBall();
        roundStartTime = performance.now(); recording = true; waiting = false; m3SpacePressed = false; roundNeedsSpace = false;
        const delay = Math.random()*1500 + 600;
        setTimeout(()=>{
            target = getRandomMode3Target();
            signalTime = performance.now(); waiting = true;
            animateBallMode3(target, ()=>{
                if(!roundNeedsSpace){
                    m3TimeoutId = setTimeout(()=>{
                        if(waiting){ waiting = false; recording = false; finalizeKeys(performance.now()); evaluateMode3(); }
                    },1200);
                }
            });
        }, delay);
        return;
    }
    // Mode 1-2
    roundStartTime = performance.now(); recording = true; waiting = false; firstDir = null; firstDirTime = null; spaceTime = null; allKeySegments = []; allSpacePresses = [];
    const ball = $('ball'); const delay = Math.random()*1500 + 500;
    setTimeout(()=>{
        target = Math.random()<.5 ? 'A' : 'D';
        signalTime = performance.now(); waiting = true;
        if(mode===1){ $(target==='A'?'left':'right').classList.add('active'); }
        if(mode===2){ ball.style.display='block'; ball.style.left='50%'; ball.style.top='0%'; ball.style.transition='none'; ball.style.transform='translate(-50%,0%)'; requestAnimationFrame(()=>requestAnimationFrame(()=>{ ball.style.transition='all 0.35s linear'; ball.style.left=target==='A'?'20%':'80%'; ball.style.top='80%'; })); }
    }, delay);
}

function startDuelRoundProcess() {
    if(attempts >= maxAttempts){ showResults(); return; }
    Duel.currentRoundData = null; Duel.opponentRoundData = null;
    $('info').textContent = `–†–∞—É–Ω–¥ ${attempts+1} / ${maxAttempts}`;
    $('info').style.color = "#888";
    clearMode3Ball(); showIdleBall();
    roundStartTime = performance.now(); recording = true; waiting = false; m3SpacePressed = false; roundNeedsSpace = false;
    const delay = Math.random()*1500 + 600;
    setTimeout(()=>{
        target = Duel.targets[attempts];
        signalTime = performance.now(); waiting = true;
        animateBallMode3(target, ()=>{
            if(!roundNeedsSpace){
                m3TimeoutId = setTimeout(()=>{
                    if(waiting){ waiting = false; recording = false; finalizeKeys(performance.now()); evaluateMode3(); }
                },1200);
            }
        });
    }, delay);
}

document.addEventListener('keydown',e=>{
    if(!recording)return; if(e.repeat)return; const now=performance.now(); const code=e.code;
    if((code==='KeyA'||code==='KeyD'||(code==='KeyW'&&(mode===3||mode===4)))&&!allKeyDowns[code]){
        allKeyDowns[code]=now;
        if(!firstDir&&waiting){ if(code==='KeyA')firstDir='A'; else if(code==='KeyD')firstDir='D'; else if(code==='KeyW')firstDir='W'; firstDirTime=now; }
    }
    if(code==='Space'){
        allSpacePresses.push(now);
        if((mode===3||mode===4)&&waiting){
            spaceTime=now;m3SpacePressed=true;
            if(!firstDir){ if(allKeyDowns['KeyA']){firstDir='A';firstDirTime=allKeyDowns['KeyA'];} else if(allKeyDowns['KeyD']){firstDir='D';firstDirTime=allKeyDowns['KeyD'];} else if(allKeyDowns['KeyW']){firstDir='W';firstDirTime=allKeyDowns['KeyW'];} }
            waiting=false;recording=false;
            if(m3TimeoutId){clearTimeout(m3TimeoutId);m3TimeoutId=null;}
            finalizeKeys(now);
            evaluateMode3();
            return;
        }
        if(waiting&&!spaceTime&&mode!==3&&mode!==4){
            spaceTime=now;
            if(!firstDir){ if(allKeyDowns['KeyA']){firstDir='A';firstDirTime=allKeyDowns['KeyA'];} else if(allKeyDowns['KeyD']){firstDir='D';firstDirTime=allKeyDowns['KeyD'];} }
            waiting=false;recording=false; finalizeKeys(now); evaluate();
        }
    }
});
document.addEventListener('keyup',e=>{ const now=performance.now(); const code=e.code; if(allKeyDowns[code]){ allKeySegments.push({code,down:allKeyDowns[code],up:now}); delete allKeyDowns[code]; } });
function finalizeKeys(endTime){ for(const code of Object.keys(allKeyDowns)){ allKeySegments.push({code,down:allKeyDowns[code],up:endTime}); } allKeyDowns={}; }

function evaluateMode3(){
    let resultMsg, ok=false;
    const reaction=spaceTime?Math.round(spaceTime-signalTime):null;
    if(!roundNeedsSpace){
        if(m3SpacePressed){ resultMsg='–ú—è—á –º–∏–º–æ ‚Äî –Ω–µ –ø—Ä—ã–≥–∞–π!'; } else { ok=true; resultMsg='–ú—è—á –º–∏–º–æ ‚Äî –≤–µ—Ä–Ω–æ!'; }
    }else{
        if(!m3SpacePressed){ resultMsg='–ù–µ –ø—Ä—ã–≥–Ω—É–ª!'; }
        else if(!firstDir){ resultMsg='SPACE –±–µ–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'; }
        else if(spaceTime+tolerance<firstDirTime){ resultMsg='SPACE —Ä–∞–Ω—å—à–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'; }
        else if(firstDir!==target){ resultMsg='–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞'; }
        else { ok=true; resultMsg=`${reaction} –º—Å`; }
    }
    let targetLabel;
    switch(target){ case 'A':targetLabel='‚Üê –õ–µ–≤—ã–π —É–≥–æ–ª';break; case 'D':targetLabel='‚Üí –ü—Ä–∞–≤—ã–π —É–≥–æ–ª';break; case 'W':targetLabel='‚Üë –¶–µ–Ω—Ç—Ä –≤–æ—Ä–æ—Ç';break; case 'OUT_TOP':targetLabel='‚¨Ü –ù–∞–¥ –≤–æ—Ä–æ—Ç–∞–º–∏';break; case 'OUT_LEFT':targetLabel='‚¨Ö –°–ª–µ–≤–∞ –æ—Ç –≤–æ—Ä–æ—Ç';break; case 'OUT_RIGHT':targetLabel='‚û° –°–ø—Ä–∞–≤–∞ –æ—Ç –≤–æ—Ä–æ—Ç';break; }
    const roundStats = { attempt:attempts+1, target, firstDir, ok, result:resultMsg, reactionMs:ok&&reaction?reaction:null, signalRel:signalTime-roundStartTime, spaceRel:spaceTime?spaceTime-roundStartTime:null, allSpaceRel:allSpacePresses.map(t=>t-roundStartTime), segments:allKeySegments.map(s=>({code:s.code,down:s.down-roundStartTime,up:s.up-roundStartTime})), targetLabel };
    roundData.push(roundStats);

    if(mode === 4) {
        Duel.currentRoundData = { ok: ok, reaction: (ok && reaction) ? reaction : 99999 };
        $('info').textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
        Duel.conn.send({ type: 'ROUND_RESULT', result: Duel.currentRoundData });
        checkDuelRoundComplete();
    } else {
        if(ok&&reaction!==null) reactions.push(reaction);
        const dot=$('dot'+attempts); if(dot){dot.classList.remove('current');dot.classList.add(ok?'success':'fail')}
        $('info').textContent=(ok?'‚úÖ ':'‚ùå ')+resultMsg;
        attempts++;
        setTimeout(startRound,900);
    }
}

function checkDuelRoundComplete() {
    if(Duel.currentRoundData && Duel.opponentRoundData) {
        const my = Duel.currentRoundData;
        const opp = Duel.opponentRoundData;
        let roundWinner = null; 
        if (my.ok && !opp.ok) { Duel.myScore++; roundWinner = 'me'; } 
        else if (!my.ok && opp.ok) { Duel.oppScore++; roundWinner = 'opp'; } 
        else if (my.ok && opp.ok) {
            if(my.reaction < opp.reaction) { Duel.myScore++; roundWinner = 'me'; } 
            else if (opp.reaction < my.reaction) { Duel.oppScore++; roundWinner = 'opp'; }
        }
        updateDuelScoreUI();
        const dot=$('dot'+attempts);
        if(dot){
            dot.classList.remove('current');
            if(roundWinner === 'me') dot.classList.add('success');
            else if(roundWinner === 'opp') dot.classList.add('fail');
            else dot.classList.add('draw');
        }
        let infoText = "";
        if(my.ok) infoText += `–í—ã: ${my.reaction}–º—Å. `; else infoText += `–í—ã: –û—à–∏–±–∫–∞. `;
        if(opp.ok) infoText += `–°–æ–ø: ${opp.reaction}–º—Å.`; else infoText += `–°–æ–ø: –û—à–∏–±–∫–∞.`;
        $('info').textContent = infoText;
        $('info').style.color = roundWinner === 'me' ? 'var(--success)' : (roundWinner === 'opp' ? 'var(--fail)' : 'var(--warn)');
        if(opp.ok) Duel.opponentReactions.push(opp.reaction);
        attempts++;
        setTimeout(startDuelRoundProcess, 2000);
    }
}
function updateDuelScoreUI() { $('duelScore').innerHTML = `<span style="color:var(--accent)">YOU</span> ${Duel.myScore} : ${Duel.oppScore} <span style="color:var(--fail)">OPP</span>`; }
function evaluate(){ let result,ok=false; if(!firstDir){ result='SPACE –±–µ–∑ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'; }else if(spaceTime+tolerance<firstDirTime){ result='SPACE —Ä–∞–Ω—å—à–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è'; }else if(firstDir!==target){ result='–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞'; }else{ const reaction=Math.round(spaceTime-signalTime); reactions.push(reaction); result=`${reaction} –º—Å`;ok=true; } const dot=$('dot'+attempts); if(dot){dot.classList.remove('current');dot.classList.add(ok?'success':'fail')} roundData.push({ attempt:attempts+1,target,firstDir,ok,result, reactionMs:ok?Math.round(spaceTime-signalTime):null, signalRel:signalTime-roundStartTime, spaceRel:spaceTime?spaceTime-roundStartTime:null, allSpaceRel:allSpacePresses.map(t=>t-roundStartTime), segments:allKeySegments.map(s=>({code:s.code,down:s.down-roundStartTime,up:s.up-roundStartTime})) }); attempts++; $('info').textContent=(ok?'‚úÖ ':'‚ùå ')+result; setTimeout(startRound,700); }
function showResults(){
    $('info').textContent='';
    if(mode===3 || mode===4)$('mode3Area').style.display='none';
    $('resultsOverlay').classList.add('show');
    let html = "";
    if(mode === 4) {
        let resultTitle = "–ù–∏—á—å—è!";
        if(Duel.myScore > Duel.oppScore) resultTitle = "–í—ã –ø–æ–±–µ–¥–∏–ª–∏! üèÜ";
        if(Duel.oppScore > Duel.myScore) resultTitle = "–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–±–µ–¥–∏–ª";
        html += `<div class="res-title">${resultTitle}</div>`;
        html += `<div class="res-avg" style="font-size:28px">–°—á–µ—Ç: <span style="color:var(--accent)">${Duel.myScore}</span> - <span style="color:var(--fail)">${Duel.oppScore}</span></div>`;
        const myAvg = reactions.length ? Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length) : '‚Äî';
        const oppAvg = Duel.opponentReactions.length ? Math.round(Duel.opponentReactions.reduce((a,b)=>a+b,0)/Duel.opponentReactions.length) : '‚Äî';
        html += `<div class="res-avg" style="margin-bottom:20px">–°—Ä. —Ä–µ–∞–∫—Ü–∏—è (–í—ã): ${myAvg} –º—Å <br> –°—Ä. —Ä–µ–∞–∫—Ü–∏—è (–°–æ–ø): ${oppAvg} –º—Å</div>`;
        html += `<div class="btn-row"> <button class="back-btn" onclick="backToMenu()">–í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é</button> </div>`;
    } else {
        let avg='‚Äî'; if(reactions.length)avg=Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length)+' –º—Å';
        html=`<div class="res-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div><div class="res-avg">–°—Ä–µ–¥–Ω—è—è —Ä–µ–∞–∫—Ü–∏—è: ${avg}</div>`;
        for(const rd of roundData)html+=buildRoundCard(rd);
        html+=`<div class="btn-row"> <button class="restart-btn" onclick="restartSameMode()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button> <button class="back-btn" onclick="backToMenu()">–í –º–µ–Ω—é</button> </div>`;
    }
    $('resultsContent').innerHTML=html;
}
function backToMenu(){
    if(Duel.active) { if(Duel.conn) Duel.conn.close(); if(Duel.peer) Duel.peer.destroy(); Duel.peer = null; Duel.conn = null; Duel.active = false; }
    $('resultsOverlay').classList.remove('show'); $('menu').style.display='flex'; $('gameArea').style.display='none'; $('mode3Area').style.display='none'; $('duelScore').style.display='none';
    window.history.replaceState({}, document.title, window.location.pathname);
}
function restartSameMode(){ $('resultsOverlay').classList.remove('show'); if(mode !== 4) { startGame(mode); } }
function buildRoundCard(rd){ const sig=rd.signalRel; let maxT=sig+200,minT=0; for(const s of rd.segments){maxT=Math.max(maxT,s.up);minT=Math.min(minT,s.down);} if(rd.spaceRel)maxT=Math.max(maxT,rd.spaceRel); for(const t of rd.allSpaceRel)maxT=Math.max(maxT,t); const pad=Math.max((maxT-minT)*0.08,30); minT-=pad;maxT+=pad; const range=maxT-minT; const toP=t=>((t-minT)/range*100); let inner=''; const sigP=toP(sig); inner+=`<div class="tl-prezone" style="left:0;width:${sigP}%"></div>`; inner+=`<div class="tl-signal-line" style="left:${sigP}%"></div>`; inner+=`<div class="tl-marker signal-mk" style="left:${sigP}%"></div>`; for(const s of rd.segments){ if(s.code==='KeyA'||s.code==='KeyD'||s.code==='KeyW'){ const l=toP(s.down),r=toP(s.up); const isA=s.code==='KeyA'; const isW=s.code==='KeyW'; const cls=isA?'key-a':isW?'key-w':'key-d'; const yOff=isA?-14:isW?-2:10; const w=Math.max(r-l,0.4); inner+=`<div class="tl-bar ${cls}" style="left:${l}%;width:${w}%;top:calc(50% + ${yOff}px)"></div>`; } } for(const t of rd.allSpaceRel){ inner+=`<div class="tl-marker space-mk" style="left:${toP(t)}%"></div>`; } const nTicks=6;let ticks=''; for(let i=0;i<=nTicks;i++){ const t=minT+(range*i/nTicks); const rel=Math.round(t-sig); const label=(rel>=0?'+':'')+rel; ticks+=`<div class="tl-label" style="left:${toP(t)}%">${label}</div>`; } ticks+=`<div class="tl-label top" style="left:${sigP}%;color:#fff;font-weight:bold">‚ñº —Å–∏–≥–Ω–∞–ª</div>`; if(rd.spaceRel!=null){ ticks+=`<div class="tl-label top" style="left:${toP(rd.spaceRel)}%;color:var(--warn)">SPACE</div>`; } const resultClass=rd.ok?'ok':'err'; const targetInfo=rd.targetLabel?`<span style="margin-left:12px;font-weight:400;color:#aaa">–¶–µ–ª—å: ${rd.targetLabel}</span>`:''; return `<div class="round-card"> <div class="round-header"> <span class="round-num">–†–∞—É–Ω–¥ ${rd.attempt}</span> <span class="round-result ${resultClass}">${rd.result}${targetInfo}</span> </div> <div class="timeline-wrap"> <div class="tl-axis"></div> ${inner} ${ticks} </div> </div>`; }

init();
</script>
</body>
</html>

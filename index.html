<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Reaction Test</title>

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#0a0a0f;
  color:#fff;
  font-family:'Outfit',sans-serif;
  height:100vh;
  overflow:hidden;
}
button{
  padding:14px 32px;
  font-size:18px;
  border-radius:10px;
  border:2px solid #1e1e2e;
  background:#14141f;
  color:#fff;
  cursor:pointer;
}
button:hover{border-color:#00e5ff}

#menu,#waiting,#results{
  position:fixed;inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:16px;
}

#waiting{display:none}
#results{display:none}

canvas{
  position:fixed;
  inset:0;
}
#hud{
  position:fixed;
  top:16px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:6px;
}
.dot{
  width:12px;
  height:12px;
  border-radius:50%;
  border:2px solid #333;
}
.dot.ok{background:#00e676;border-color:#00e676}
.dot.fail{background:#ff3d71;border-color:#ff3d71}

#info{
  position:fixed;
  bottom:16px;
  width:100%;
  text-align:center;
  font-family:'JetBrains Mono';
  color:#aaa;
}
input{
  width:420px;
  max-width:90vw;
  padding:10px;
  background:#14141f;
  border:1px solid #333;
  color:#00e5ff;
  text-align:center;
}
</style>
</head>

<body>

<div id="menu">
  <h1>GK Reaction Test</h1>
  <button onclick="startSolo()">Режим 3 — Соло</button>
  <button onclick="createDuel()">Режим 4 — Дуэль</button>
</div>

<div id="waiting">
  <h2>Комната ожидания</h2>
  <p>Отправь ссылку другу</p>
  <input id="link" readonly>
  <button onclick="copy()">Скопировать</button>
</div>

<div id="results">
  <h2 id="resText"></h2>
  <button onclick="location.reload()">В меню</button>
</div>

<canvas id="canvas"></canvas>
<div id="hud"></div>
<div id="info"></div>

<script>
/* ================== CANVAS ================== */
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
window.onresize=resize;
resize();

/* ================== DUEL STATE ================== */
let peer,conn,isHost=false;
let rounds=[],roundIndex=0;
let my=[],enemy=[];
let waiting=false;
let signalTime=0;

/* ================== UI ================== */
const hud=document.getElementById('hud');
function buildHud(){
  hud.innerHTML='';
  for(let i=0;i<15;i++){
    const d=document.createElement('div');
    d.className='dot';
    d.id='d'+i;
    hud.appendChild(d);
  }
}

/* ================== DRAW ================== */
function drawBall(y){
  ctx.fillStyle='#0a0a0f';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff';
  ctx.beginPath();
  ctx.arc(canvas.width/2,y,14,0,Math.PI*2);
  ctx.fill();
}

/* ================== ROUNDS ================== */
function genRounds(){
  return Array.from({length:15},()=>({
    delay:600+Math.random()*1200,
    goal:Math.random()<0.7
  }));
}

function startRound(){
  if(roundIndex>=15){
    finish();
    return;
  }
  document.getElementById('info').textContent='Раунд '+(roundIndex+1);
  const r=rounds[roundIndex];
  setTimeout(()=>{
    signalTime=performance.now();
    animate(r.goal);
  },r.delay);
}

function animate(goal){
  let y=0;
  function frame(){
    y+=12;
    drawBall(y);
    if(y<canvas.height*0.75){
      requestAnimationFrame(frame);
    }else{
      if(goal){
        waiting=true;
      }else{
        endRound(true,null);
      }
    }
  }
  frame();
}

/* ================== INPUT ================== */
document.addEventListener('keydown',e=>{
  if(e.code!=='Space'||!waiting)return;
  const rt=Math.round(performance.now()-signalTime);
  endRound(true,rt);
});

function endRound(ok,rt){
  waiting=false;
  my.push({ok,rt});
  document.getElementById('d'+roundIndex)
    .classList.add(ok?'ok':'fail');
  roundIndex++;
  setTimeout(startRound,600);
}

/* ================== FINISH ================== */
function finish(){
  if(conn){
    conn.send({type:'RES',data:my});
  }
  if(enemy.length){
    showResult();
  }
}

function showResult(){
  let a=0,b=0;
  for(let i=0;i<15;i++){
    if(my[i].ok&&!enemy[i].ok)a++;
    else if(!my[i].ok&&enemy[i].ok)b++;
    else if(my[i].ok&&enemy[i].ok){
      if(my[i].rt<enemy[i].rt)a++;
      else if(enemy[i].rt<my[i].rt)b++;
    }
  }
  document.getElementById('menu').style.display='none';
  document.getElementById('results').style.display='flex';
  document.getElementById('resText').textContent=
    a>b?'ПОБЕДА '+a+':'+b:'ПОРАЖЕНИЕ '+a+':'+b;
}

/* ================== DUEL ================== */
function createDuel(){
  isHost=true;
  peer=new Peer();
  peer.on('open',id=>{
    document.getElementById('menu').style.display='none';
    document.getElementById('waiting').style.display='flex';
    document.getElementById('link').value=
      location.origin+location.pathname+'?duel='+id;
  });
  peer.on('connection',c=>{
    conn=c;
    rounds=genRounds();
    conn.send({type:'INIT',rounds});
    startGame();
  });
}

function startGame(){
  document.getElementById('waiting').style.display='none';
  buildHud();
  roundIndex=0;
  my=[];
  startRound();
}

function copy(){
  navigator.clipboard.writeText(
    document.getElementById('link').value
  );
}

function onMsg(m){
  if(m.type==='INIT'){
    rounds=m.rounds;
    startGame();
  }
  if(m.type==='RES'){
    enemy=m.data;
    showResult();
  }
}

/* ================== JOIN ================== */
const q=new URLSearchParams(location.search);
if(q.get('duel')){
  peer=new Peer();
  peer.on('open',()=>{
    conn=peer.connect(q.get('duel'));
    conn.on('data',onMsg);
  });
}
</script>

</body>
</html>

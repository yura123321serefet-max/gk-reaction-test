<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Reaction Test - DUEL</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #0e0e0e; --card: #1a1a1a; --accent: #007bff;
            --success: #28a745; --warn: #ffc107; --err: #dc3545; --text: #e0e0e0;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .menu-card, .mode-area { background: var(--card); padding: 20px; border-radius: 12px; margin-top: 50px; width: 90%; max-width: 500px; text-align: center; }
        button { background: var(--accent); border: none; color: white; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        input[type="text"] { background: #333; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; width: 80%; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥—É—ç–ª–∏ */
        #duelLobby, #duelFinish {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        th, td { padding: 8px; border-bottom: 1px solid #333; text-align: center; }
        .win-star { color: var(--warn); font-weight: bold; }
    </style>
</head>
<body>

<div id="menu" class="menu-card">
    <h1>GK Reaction Test</h1>
    <button onclick="startMode(3)">–†–µ–∂–∏–º 3 (–û–±—ã—á–Ω—ã–π)</button>
    <button onclick="initDuel()" style="background: #6f42c1;">–†–ï–ñ–ò–ú 4: –î–£–≠–õ–¨</button>
</div>

<div id="duelLobby">
    <h2>–î—É—ç–ª—å: –û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∞</h2>
    <p>–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</p>
    <input type="text" id="shareLink" readonly onclick="this.select()">
    <p id="connectionStatus">–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...</p>
    <button onclick="location.href=location.pathname">–û—Ç–º–µ–Ω–∞</button>
</div>

<div id="gameArea" class="mode-area" style="display:none;">
    <h2 id="status">–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å...</h2>
    <div id="targetDisplay" style="font-size: 48px; margin: 20px;"></div>
    <p>–†–∞—É–Ω–¥: <span id="roundNum">0</span>/15</p>
</div>

<div id="duelFinish">
    <h1 id="duelWinnerText">–ö–¢–û –í–´–ò–ì–†–ê–õ?</h1>
    <h2 id="duelScoreDetail">0 : 0</h2>
    <div id="duelTable" style="width: 90%; max-width: 400px; max-height: 50vh; overflow-y: auto;"></div>
    <button onclick="location.href=location.pathname" style="margin-top: 20px;">–í –ú–ï–ù–Æ</button>
</div>

<script>
// --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ---
let mode = 0;
let attempt = 0;
const maxAttempts = 15;
let gameActive = false;
let signalTime = 0;
let results = []; // –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ç–≤–æ–∏)

// --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–ï–¢–ò ---
let peer = null;
let conn = null;
let isHost = false;
let duelSequence = [];
let opponentResults = [];

const $ = id => document.getElementById(id);

// --- –õ–û–ì–ò–ö–ê –î–£–≠–õ–ò ---

function initDuel() {
    peer = new Peer();
    
    peer.on('open', (id) => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('join');

        if (!joinId) {
            isHost = true;
            const link = window.location.origin + window.location.pathname + '?join=' + id;
            $('shareLink').value = link;
            $('duelLobby').style.display = 'flex';
            $('connectionStatus').textContent = "–ñ–¥–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞...";
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 15 —Ä–∞—É–Ω–¥–æ–≤ –∑–∞—Ä–∞–Ω–µ–µ
            duelSequence = generateSequence(15);
        } else {
            isHost = false;
            $('duelLobby').style.display = 'flex';
            $('connectionStatus').textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥—É...";
            conn = peer.connect(joinId);
            setupConnection();
        }
    });

    peer.on('connection', (c) => {
        conn = c;
        setupConnection();
        // –•–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≥–æ—Å—Ç—é
        setTimeout(() => {
            conn.send({ type: 'START', sequence: duelSequence });
        }, 1000);
    });
}

function setupConnection() {
    conn.on('data', (data) => {
        if (data.type === 'START') {
            duelSequence = data.sequence;
            $('duelLobby').style.display = 'none';
            startDuelGame();
        }
        if (data.type === 'RESULT') {
            opponentResults.push(data.val);
            checkDuelFinish();
        }
    });
    
    conn.on('open', () => {
        if (!isHost) $('connectionStatus').textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ó–∞–≥—Ä—É–∑–∫–∞...";
    });
}

function generateSequence(n) {
    const targets = ['A', 'D', 'W', 'OUT'];
    const seq = [];
    for(let i=0; i<n; i++) {
        seq.push({
            target: targets[Math.floor(Math.random() * targets.length)],
            delay: Math.random() * 2000 + 1000
        });
    }
    return seq;
}

function startDuelGame() {
    mode = 4;
    attempt = 0;
    results = [];
    opponentResults = [];
    $('menu').style.display = 'none';
    $('gameArea').style.display = 'block';
    nextRound();
}

function nextRound() {
    if (attempt >= maxAttempts) return;
    attempt++;
    $('roundNum').textContent = attempt;
    $('status').textContent = "–ü–†–ò–ì–û–¢–û–í–ò–¢–¨–°–Ø...";
    $('targetDisplay').textContent = "";
    
    const currentRound = duelSequence[attempt-1];
    
    setTimeout(() => {
        signalTime = Date.now();
        $('status').textContent = "–ñ–ú–ò!";
        $('targetDisplay').textContent = currentRound.target;
        gameActive = true;
    }, currentRound.delay);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
window.onkeydown = (e) => {
    if (!gameActive) return;
    gameActive = false;
    
    const reaction = Date.now() - signalTime;
    const key = e.code === 'KeyA' ? 'A' : e.code === 'KeyD' ? 'D' : e.code === 'KeyW' ? 'W' : 'SPACE';
    const correct = key === duelSequence[attempt-1].target || (key === 'SPACE' && duelSequence[attempt-1].target === 'OUT');
    
    const res = { ok: correct, reactionMs: reaction, target: duelSequence[attempt-1].target };
    results.push(res);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥—Ä—É–≥—É
    conn.send({ type: 'RESULT', val: res });
    
    $('status').textContent = correct ? `–í–ï–†–ù–û! ${reaction}–º—Å` : "–û–®–ò–ë–ö–ê!";
    
    setTimeout(() => {
        if (attempt < maxAttempts) nextRound();
        else checkDuelFinish();
    }, 1500);
};

function checkDuelFinish() {
    if (results.length === 15 && opponentResults.length === 15) {
        showFinalResults();
    }
}

function showFinalResults() {
    let myScore = 0, oppScore = 0;
    let tableHtml = `<table><tr><th>‚Ññ</th><th>–¢—ã</th><th>–î—Ä—É–≥</th><th>–ë–∞–ª–ª</th></tr>`;

    for (let i = 0; i < 15; i++) {
        const r1 = results[i], r2 = opponentResults[i];
        let winner = '';

        // –¢–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        if (r1.ok && (!r2.ok || r1.reactionMs < r2.reactionMs)) {
            myScore++; winner = '‚òÖ';
        } else if (r2.ok && (!r1.ok || r2.reactionMs < r1.reactionMs)) {
            oppScore++; winner = '‚òÜ';
        }

        tableHtml += `<tr>
            <td>${i+1}</td>
            <td style="color:${r1.ok?'#4caf50':'#ff5252'}">${r1.ok?r1.reactionMs:'X'}</td>
            <td style="color:${r2.ok?'#4caf50':'#ff5252'}">${r2.ok?r2.reactionMs:'X'}</td>
            <td><span class="win-star">${winner}</span></td>
        </tr>`;
    }
    tableHtml += `</table>`;

    $('duelWinnerText').textContent = myScore > oppScore ? "–¢–´ –ü–û–ë–ï–î–ò–õ! üèÜ" : (myScore < oppScore ? "–î–†–£–ì –ü–û–ë–ï–î–ò–õ! üíÄ" : "–ù–ò–ß–¨–Ø! ü§ù");
    $('duelScoreDetail').textContent = `${myScore} : ${oppScore}`;
    $('duelTable').innerHTML = tableHtml;
    $('duelFinish').style.display = 'flex';
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = () => {
    if (new URLSearchParams(window.location.search).has('join')) {
        initDuel();
    }
};
</script>
</body>
</html>

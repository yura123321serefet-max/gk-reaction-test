<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Reaction Test</title>

<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#0a0a0f;
  color:#e0e0e0;
  font-family:'Outfit',sans-serif;
  height:100vh;
  overflow:hidden;
}

/* ===== MENU ===== */
#menu{
  position:fixed;inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:18px;
  z-index:1000;
}
.menu-btn{
  padding:16px 36px;
  font-size:18px;
  font-weight:700;
  border-radius:12px;
  border:2px solid #1e1e2e;
  background:#14141f;
  color:#fff;
  cursor:pointer;
}
.menu-btn:hover{border-color:#00e5ff}

/* ===== WAITING ROOM ===== */
#waitingRoom{
  position:fixed;inset:0;
  background:#0a0a0f;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:18px;
  z-index:1500;
  text-align:center;
}
#duelLink{
  width:420px;
  max-width:90vw;
  padding:12px;
  border-radius:8px;
  border:1px solid #333;
  background:#14141f;
  color:#00e5ff;
  text-align:center;
  font-family:'JetBrains Mono';
}

/* ===== HUD ===== */
#hud{
  position:fixed;
  top:16px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:6px;
}
.dot{
  width:14px;
  height:14px;
  border-radius:50%;
  border:2px solid #333;
}
.dot.success{background:#00e676;border-color:#00e676}
.dot.fail{background:#ff3d71;border-color:#ff3d71}

/* ===== INFO ===== */
#info{
  position:fixed;
  bottom:16px;
  width:100%;
  text-align:center;
  font-family:'JetBrains Mono';
  color:#aaa;
}

/* ===== RESULTS ===== */
#resultsOverlay{
  position:fixed;
  inset:0;
  background:#0a0a0f;
  display:none;
  z-index:2000;
  padding:40px;
  text-align:center;
}
#resultsOverlay.show{display:block}
</style>
</head>

<body>

<!-- ===== MENU ===== -->
<div id="menu">
  <h1>GK Reaction Test</h1>
  <button class="menu-btn" onclick="startSolo()">–†–µ–∂–∏–º 3 ‚Äî –°–æ–ª–æ</button>
  <button class="menu-btn" onclick="createDuel()">–†–µ–∂–∏–º 4 ‚Äî –î—É—ç–ª—å</button>
</div>

<!-- ===== WAITING ROOM ===== -->
<div id="waitingRoom">
  <h2>–ö–æ–º–Ω–∞—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è</h2>
  <p style="color:#aaa;max-width:420px">
    –û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É.<br>
    –ò–≥—Ä–∞ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –æ–Ω –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è.
  </p>
  <input id="duelLink" readonly>
  <button class="menu-btn" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
  <button class="menu-btn" onclick="cancelDuel()">–û—Ç–º–µ–Ω–∞</button>
</div>

<div id="hud"></div>
<div id="info"></div>
<div id="resultsOverlay"></div>

<script>
/* =====================================================
   DUEL / PEERJS
===================================================== */
let peer, conn;
let isHost = false;
let duelRounds = [];
let duelIndex = 0;
let myResults = [];
let enemyResults = [];

function createDuel(){
  isHost = true;
  peer = new Peer();

  peer.on('open', id=>{
    const link = location.origin + location.pathname + '?duel=' + id;
    document.getElementById('menu').style.display='none';
    document.getElementById('waitingRoom').style.display='flex';
    document.getElementById('duelLink').value = link;
  });

  peer.on('connection', c=>{
    conn = c;
    conn.on('open', ()=>{
      document.getElementById('waitingRoom').style.display='none';
      startDuelAsHost();
    });
    conn.on('data', onMessage);
  });
}

function joinDuel(hostId){
  isHost = false;
  peer = new Peer();
  peer.on('open', ()=>{
    conn = peer.connect(hostId);
    conn.on('data', onMessage);
  });
}

function cancelDuel(){
  if(conn) conn.close();
  if(peer) peer.destroy();
  document.getElementById('waitingRoom').style.display='none';
  document.getElementById('menu').style.display='flex';
}

function copyLink(){
  navigator.clipboard.writeText(
    document.getElementById('duelLink').value
  );
  alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
}

function startDuelAsHost(){
  duelRounds = generateRounds();
  conn.send({type:'INIT', rounds:duelRounds});
  startGame();
}

function onMessage(msg){
  if(msg.type==='INIT'){
    duelRounds = msg.rounds;
    startGame();
  }
  if(msg.type==='RESULTS'){
    enemyResults = msg.results;
    finishCompare();
  }
}

/* =====================================================
   GAME LOGIC (SIMPLIFIED MODE 3)
===================================================== */
let attempts = 0;
const MAX = 15;
let signalTime = null;
let currentTarget = null;

function generateRounds(){
  const arr=[];
  for(let i=0;i<15;i++){
    arr.push({
      target: ['A','D','W','OUT'][Math.floor(Math.random()*4)],
      delay: Math.random()*1500+600
    });
  }
  return arr;
}

function startGame(){
  attempts=0;
  duelIndex=0;
  myResults=[];
  enemyResults=[];
  document.getElementById('menu').style.display='none';
  buildHud();
  startRound();
}

function buildHud(){
  let h='';
  for(let i=0;i<MAX;i++) h+=`<div class="dot" id="dot${i}"></div>`;
  document.getElementById('hud').innerHTML=h;
}

function startRound(){
  if(attempts>=MAX){
    sendResults();
    return;
  }
  const r = duelRounds[duelIndex];
  document.getElementById('info').textContent = '–†–∞—É–Ω–¥ ' + (attempts+1);
  setTimeout(()=>{
    currentTarget = r.target;
    signalTime = performance.now();
  }, r.delay);
}

document.addEventListener('keydown',e=>{
  if(!signalTime)return;
  if(e.code!=='Space')return;

  const rt = Math.round(performance.now()-signalTime);
  const ok = currentTarget!=='OUT';
  myResults.push({ok,reaction:ok?rt:null});
  mark(ok);
  attempts++;
  duelIndex++;
  signalTime=null;
  setTimeout(startRound,600);
});

function mark(ok){
  document.getElementById('dot'+attempts)
    .className = 'dot ' + (ok?'success':'fail');
}

/* =====================================================
   RESULTS
===================================================== */
function sendResults(){
  if(conn) conn.send({type:'RESULTS',results:myResults});
  if(enemyResults.length) finishCompare();
}

function finishCompare(){
  const r = compare(myResults,enemyResults);
  const o = document.getElementById('resultsOverlay');
  o.classList.add('show');
  o.innerHTML = `
    <h2>–î—É—ç–ª—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h2>
    <p>–¢—ã: ${r.me} ¬∑ –°–æ–ø–µ—Ä–Ω–∏–∫: ${r.enemy}</p>
    <h1>${r.me>r.enemy?'üèÜ –ü–û–ë–ï–î–ê':'üíÄ –ü–û–†–ê–ñ–ï–ù–ò–ï'}</h1>
    <br>
    <button class="menu-btn" onclick="location.reload()">–í –º–µ–Ω—é</button>
  `;
}

function compare(a,b){
  let me=0,enemy=0;
  for(let i=0;i<15;i++){
    if(a[i].ok && !b[i].ok) me++;
    else if(!a[i].ok && b[i].ok) enemy++;
    else if(a[i].ok && b[i].ok){
      if(a[i].reaction < b[i].reaction) me++;
      else if(b[i].reaction < a[i].reaction) enemy++;
    }
  }
  return {me,enemy};
}

/* =====================================================
   SOLO MODE
===================================================== */
function startSolo(){
  duelRounds = generateRounds();
  startGame();
}

/* =====================================================
   AUTO JOIN
===================================================== */
const q = new URLSearchParams(location.search);
if(q.get('duel')) joinDuel(q.get('duel'));
</script>

</body>
</html>

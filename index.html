<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rematch GK Reaction Test</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{
  --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f;
  --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00;
}

/* ПЕРЕКЛЮЧАТЕЛЬ ЯЗЫКА */
#langSelector{
  position:fixed;top:16px;left:16px;z-index:1100;
}
#langMainBtn{
  padding:10px 16px;background:var(--card);border:1px solid var(--border);
  color:#fff;border-radius:8px;cursor:pointer;font-weight:700;transition:all 0.2s;
}
#langOptions{
  display:none;flex-direction:column;gap:4px;margin-top:4px;
  background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden;
}
#langOptions button{
  padding:10px;background:transparent;border:none;color:#fff;cursor:pointer;font-family:inherit;text-align:left;
}
#langOptions button:hover{background:rgba(255,255,255,0.1);color:var(--accent)}

/* КНОПКА ПАУЗЫ */
#pauseBtn{
  position:fixed;top:16px;left:16px;z-index:100;
  padding:10px 20px;background:rgba(20,20,31,0.8);border:1px solid var(--border);
  color:#fff;border-radius:8px;cursor:pointer;font-weight:700;display:none;
  backdrop-filter:blur(4px);transition:all 0.2s;
}
#pauseBtn:hover{border-color:var(--accent);color:var(--accent)}

#pauseOverlay{
  position:fixed;inset:0;background:rgba(10,10,15,0.85);z-index:1500;
  display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px;
  backdrop-filter:blur(8px);
}

#menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:1000}
#menu h1{font-size:42px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu p{color:#888;font-size:14px;max-width:420px;text-align:center;line-height:1.6;padding:0 20px}

.menu-btn{
  padding:16px 36px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700;
  border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff;
  cursor:pointer;transition:all .2s;min-width:280px;
}
.menu-btn:hover{border-color:var(--accent);box-shadow:0 0 24px rgba(0,229,255,.15);transform:translateY(-2px)}
.menu-btn span{color:#888;font-weight:300;font-size:14px;display:block;margin-top:4px}

#gameArea{flex:1;display:flex;position:relative;overflow:hidden}
.side{flex:1;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;font-family:'JetBrains Mono',monospace;opacity:.06;transition:all .15s;user-select:none;letter-spacing:4px}
.side.active{opacity:1;color:#000}
#left.active{background:var(--accent)}
#right.active{background:var(--accent)}

#ball{position:absolute;width:36px;height:36px;border-radius:50%;background:#fff;left:50%;top:0%;transform:translate(-50%,0%);display:none;box-shadow:0 0 20px rgba(255,255,255,.5);z-index:10}
#hud{position:fixed;top:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:50;flex-wrap:wrap;justify-content:center;max-width:90vw}
.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333;transition:all .3s}
.dot.success{background:var(--success);border-color:var(--success);box-shadow:0 0 8px var(--success)}
.dot.fail{background:var(--fail);border-color:var(--fail);box-shadow:0 0 8px var(--fail)}
.dot.current{border-color:var(--accent);box-shadow:0 0 8px var(--accent)}

#info{
  position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
  text-align:center;font-size:24px;font-family:'JetBrains Mono',monospace;font-weight:700;
  color:#fff;z-index:100;pointer-events:none;background:rgba(0, 0, 0, 0.7);
  padding:12px 28px;border-radius:50px;backdrop-filter:blur(6px);
  border:1px solid rgba(255, 255, 255, 0.15);box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  transition: all 0.2s ease;opacity:0;
}

#resultsOverlay{position:fixed;inset:0;background:rgba(10,10,15,.97);z-index:2000;display:none;flex-direction:column;align-items:center;overflow-y:auto;padding:40px 20px}
#resultsOverlay.show{display:flex}
#resultsContent{max-width:720px;width:100%}
.res-title{font-size:36px;font-weight:900;text-align:center;margin-bottom:8px;letter-spacing:-1px}
.res-avg{text-align:center;font-size:20px;color:var(--accent);font-family:'JetBrains Mono',monospace;margin-bottom:32px}

.round-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:16px}
.round-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:4px}
.round-num{font-weight:700;font-size:14px;color:#888}
.round-result{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.round-result.ok{color:var(--success)}
.round-result.err{color:var(--fail)}

.timeline-wrap{position:relative;height:64px;background:#0d0d18;border-radius:8px;overflow:hidden;border:1px solid #1a1a2a}
.tl-axis{position:absolute;top:50%;left:0;right:0;height:1px;background:#222}
.tl-signal-line{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,255,255,.25);z-index:2}
.tl-bar{position:absolute;height:10px;border-radius:3px;z-index:4;opacity:.85;min-width:3px}
.tl-bar.key-a{background:var(--accent)}
.tl-bar.key-d{background:var(--purple)}
.tl-bar.key-w{background:var(--success)}
.tl-marker{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;transform:translate(-50%,-50%);z-index:6}
.tl-marker.signal-mk{background:#fff;box-shadow:0 0 8px #fff}
.tl-marker.space-mk{background:var(--warn);box-shadow:0 0 6px var(--warn)}
.tl-prezone{position:absolute;top:0;bottom:0;background:rgba(255,255,255,.03);z-index:1;border-right:1px dashed rgba(255,255,255,.12)}

.btn-row{display:flex;flex-direction:column;align-items:center;margin-top:32px;gap:10px;padding-bottom:40px}
.restart-btn{
  padding:16px 48px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700;
  border:2px solid var(--accent);border-radius:12px;background:transparent;color:var(--accent);
  cursor:pointer;transition:all .2s;
}
.restart-btn:hover{background:var(--accent);color:#000}
.back-btn{
  padding:12px 32px;font-size:14px;font-family:'Outfit',sans-serif;font-weight:500;
  border:1px solid var(--border);border-radius:8px;background:transparent;color:#888;
  cursor:pointer;transition:all .2s;
}
.back-btn:hover{border-color:#888;color:#fff}

#mode3Area{position:fixed;inset:0;display:none;overflow:hidden;z-index:40}
#mode3Canvas{width:100%;height:100%;display:block}
.sliderRow{margin-bottom:16px}
.sliderRow label{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px;color:#aaa}
.sliderRow input{width:100%}
</style>
</head>

<body>

<div id="langSelector">
  <button id="langMainBtn" onclick="toggleLangMenu()">Language / Язык</button>
  <div id="langOptions">
    <button onclick="setLanguage('ru')">Русский</button>
    <button onclick="setLanguage('en')">English</button>
  </div>
</div>

<button id="pauseBtn" onclick="togglePause()">МЕНЮ</button>

<div id="pauseOverlay">
  <h2 id="pauseTitle" style="font-size:32px;margin-bottom:10px">ПАУЗА</h2>
  <button class="menu-btn" id="resumeBtn" onclick="togglePause()">ПРОДОЛЖИТЬ</button>
  <button class="back-btn" id="pauseBackBtn" onclick="backToMenu()">В МЕНЮ</button>
</div>

<div id="mode3Settings" style="position:fixed;inset:0;z-index:1500;background:rgba(10,10,15,.97);display:none;align-items:center;justify-content:center;">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;width:420px;max-width:90vw;">
    <h2 id="settingsTitle" style="font-size:28px;margin-bottom:16px">Настройка ударов</h2>
    <div class="sliderRow">
      <label><span id="labelOut">Мимо ворот</span>: <b><span id="pOut">30</span>%</b></label>
      <input type="range" min="0" max="100" value="30" id="outRange">
    </div>
    <div class="sliderRow">
      <label><span id="labelSide">В створ (углы)</span>: <b><span id="pSide">50</span>%</b></label>
      <input type="range" min="0" max="100" value="50" id="sideRange">
    </div>
    <div class="sliderRow">
      <label><span id="labelCenter">По центру</span>: <b><span id="pCenter">20</span>%</b></label>
      <input type="range" min="0" max="100" value="20" id="centerRange">
    </div>
    <button class="menu-btn" style="margin-top:20px" id="startMode3">
      OK
      <span id="startMode3Sub">Запустить режим</span>
    </button>
  </div>
</div>

<div id="menu">
  <h1>GK Reaction Test</h1>
  <p id="menuDesc">Нажми <b>A</b> или <b>D</b> чтобы выбрать сторону, затем <b>SPACE</b> чтобы прыгнуть. Направление должно быть нажато до или одновременно с прыжком.</p>
  <button class="menu-btn" id="mode1">Режим 1 — Сигнал<span id="m1Sub">Сторона подсвечивается</span></button>
  <button class="menu-btn" id="mode2">Режим 2 — Мяч<span id="m2Sub">Мяч летит в угол</span></button>
  <button class="menu-btn" id="mode3btn">Режим 3 — Ворота 3D<span id="m3Sub">удары по воротам · 15 раундов</span></button>
</div>

<div id="hud"></div>
<div id="gameArea">
  <div id="left" class="side">A</div>
  <div id="right" class="side">D</div>
  <div id="ball"></div>
</div>
<div id="info"></div>

<div id="mode3Area">
  <canvas id="mode3Canvas"></canvas>
</div>

<div id="resultsOverlay">
  <div id="resultsContent"></div>
</div>

<script>
// ЛОКАЛИЗАЦИЯ
const i18n = {
  ru: {
    menuDesc: "Нажми <b>A</b> или <b>D</b> чтобы выбрать сторону, затем <b>SPACE</b> чтобы прыгнуть. Направление должно быть нажато до или одновременно с прыжком.",
    mode1: "Режим 1 — Сигнал", m1Sub: "Сторона подсвечивается",
    mode2: "Режим 2 — Мяч", m2Sub: "Мяч летит в угол",
    mode3: "Режим 3 — Ворота 3D", m3Sub: "удары по воротам · 15 раундов",
    pause: "ПАУЗА", resume: "ПРОДОЛЖИТЬ", back: "В МЕНЮ", menuBtn: "МЕНЮ",
    settings: "Настройка ударов", labelOut: "Мимо ворот", labelSide: "В створ (углы)", labelCenter: "По центру", startMode: "Запустить режим",
    results: "Результаты", avgReaction: "Средняя реакция", restart: "Играть снова",
    round: "Раунд", goal: "Цель", ms: "мс",
    errSpaceOnly: "SPACE без направления", errEarlySpace: "SPACE раньше направления", errWrongSide: "Неверная сторона", errNoJump: "Не прыгнул!", errJumpOnOut: "Мяч мимо — не прыгай!",
    okOut: "Мяч мимо — верно!", okLabel: "Верно",
    tL: "← Левый угол", tR: "→ Правый угол", tC: "↑ Центр ворот", tOT: "⬆ Над воротами", tOL: "⬅ Слева от ворот", tOR: "➡ Справа от ворот"
  },
  en: {
    menuDesc: "Press <b>A</b> or <b>D</b> to choose side, then <b>SPACE</b> to jump. Direction must be pressed before or at the same time as jump.",
    mode1: "Mode 1 — Signal", m1Sub: "Side highlight",
    mode2: "Mode 2 — Ball", m2Sub: "Ball flies to corner",
    mode3: "Mode 3 — 3D Goals", m3Sub: "shots on goal · 15 rounds",
    pause: "PAUSE", resume: "CONTINUE", back: "TO MENU", menuBtn: "MENU",
    settings: "Shot Settings", labelOut: "Off-target", labelSide: "On-target (corners)", labelCenter: "Center", startMode: "Start Mode",
    results: "Results", avgReaction: "Average reaction", restart: "Restart",
    round: "Round", goal: "Target", ms: "ms",
    errSpaceOnly: "SPACE without direction", errEarlySpace: "SPACE before direction", errWrongSide: "Wrong side", errNoJump: "No jump!", errJumpOnOut: "Off-target — don't jump!",
    okOut: "Off-target — correct!", okLabel: "Correct",
    tL: "← Left Corner", tR: "→ Right Corner", tC: "↑ Center", tOT: "⬆ Over Top", tOL: "⬅ Out Left", tOR: "➡ Out Right"
  }
};

let curLang = 'ru';

function toggleLangMenu() {
  const opts = $('langOptions');
  opts.style.display = opts.style.display === 'flex' ? 'none' : 'flex';
}

function setLanguage(lang) {
  curLang = lang;
  const t = i18n[lang];
  $('menuDesc').innerHTML = t.menuDesc;
  $('mode1').firstChild.textContent = t.mode1; $('m1Sub').textContent = t.m1Sub;
  $('mode2').firstChild.textContent = t.mode2; $('m2Sub').textContent = t.m2Sub;
  $('mode3btn').firstChild.textContent = t.mode3; $('m3Sub').textContent = t.m3Sub;
  $('pauseTitle').textContent = t.pause; $('resumeBtn').textContent = t.resume; 
  $('pauseBackBtn').textContent = t.back; $('pauseBtn').textContent = t.menuBtn;
  $('settingsTitle').textContent = t.settings; $('labelOut').textContent = t.labelOut;
  $('labelSide').textContent = t.labelSide; $('labelCenter').textContent = t.labelCenter;
  $('startMode3Sub').textContent = t.startMode;
  $('langOptions').style.display = 'none';
}

// ОСНОВНАЯ ЛОГИКА
let mode3Chances = { out: 30, side: 50, center: 20 };
const $=id=>document.getElementById(id);
let mode=1,attempts=0,maxAttempts=5;
let target=null,signalTime=0;
let waiting=false,recording=false;
let roundStartTime=0;
let firstDir=null,firstDirTime=null;
let spaceTime=null;
let allKeyDowns={};
let allKeySegments=[];
let allSpacePresses=[];
let roundData=[];
let reactions=[];
const tolerance=20;
let roundNeedsSpace=false;
let isPaused = false;
let roundTimeout = null;
let m3AnimFrame=null;

function togglePause() {
  if (attempts >= maxAttempts) return;
  isPaused = !isPaused;
  $('pauseOverlay').style.display = isPaused ? 'flex' : 'none';
  if (isPaused) {
    if (roundTimeout) clearTimeout(roundTimeout);
    if (m3AnimFrame) cancelAnimationFrame(m3AnimFrame);
  } else {
    startRound();
  }
}

function resetGame(){
  attempts=0;roundData=[];reactions=[];
  $('hud').innerHTML='';$('info').textContent='';
  $('resultsOverlay').classList.remove('show');
  $('left').classList.remove('active');$('right').classList.remove('active');
  $('ball').style.display='none';
  recording=false;waiting=false;isPaused=false;
  $('pauseOverlay').style.display='none';
  buildHud();
}

function buildHud(){
  let h='';for(let i=0;i<maxAttempts;i++) h+=`<div class="dot" id="dot${i}"></div>`;
  $('hud').innerHTML=h;
}

function startGame(m){
  mode=m;
  maxAttempts = (mode===3) ? 15 : 5;
  $('menu').style.display='none';
  $('langSelector').style.display='none';
  $('pauseBtn').style.display='block';
  if(mode===3){
    $('gameArea').style.display='none';
    $('mode3Area').style.display='block';
    initMode3Canvas();
  } else {
    $('gameArea').style.display='flex';
    $('mode3Area').style.display='none';
  }
  resetGame();
  startRound();
}

$('mode1').onclick=()=>startGame(1);
$('mode2').onclick=()=>startGame(2);
$('mode3btn').onclick=()=>{
  $('menu').style.display='none';
  $('langSelector').style.display='none';
  $('mode3Settings').style.display='flex';
};

const M3={canvas:null,ctx:null,W:0,H:0};
const stadiumImg = new Image();
stadiumImg.src = 'stadium_bg.png';

function initMode3Canvas(){
  M3.canvas=$('mode3Canvas');
  M3.ctx=M3.canvas.getContext('2d');
  resizeMode3();
  window.addEventListener('resize',resizeMode3);
}

function resizeMode3(){
  const c=M3.canvas;
  c.width=window.innerWidth;
  c.height=window.innerHeight;
  M3.W=c.width;M3.H=c.height;
  drawMode3Scene();
}

function getGoalGeometry(){
  const W=M3.W,H=M3.H,cx=W/2;
  const horizonY=H*0.18, crossbarY=H*0.28, crossbarHalf=W*0.450, postBaseY=H*0.84;
  const goalHeight=postBaseY-crossbarY;
  const postBaseHalf=crossbarHalf - Math.tan(5*Math.PI/180)*goalHeight;
  return {cx, tl:{x:cx-crossbarHalf, y:crossbarY}, tr:{x:cx+crossbarHalf, y:crossbarY}, bl:{x:cx-postBaseHalf, y:postBaseY}, br:{x:cx+postBaseHalf, y:postBaseY}, crossbarY, postBaseY, crossbarHalf, postBaseHalf, horizonY};
}

function showIdleBall(){
  const g = getGoalGeometry();
  drawMode3Scene({ x: g.cx, y: g.horizonY + 20, size: 6 }); 
}

function drawMode3Scene(ballPos,impactDot){
  const ctx=M3.ctx,W=M3.W,H=M3.H;
  ctx.clearRect(0,0,W,H);
  if (stadiumImg.complete) {
    const scale = Math.max(W/stadiumImg.width, H/stadiumImg.height);
    ctx.drawImage(stadiumImg, (W-stadiumImg.width*scale)/2, (H-stadiumImg.height*scale)/2, stadiumImg.width*scale, stadiumImg.height*scale);
  } else { ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,W,H); }  
  if(impactDot){
    ctx.save(); ctx.shadowColor='rgba(0,229,255,1)'; ctx.shadowBlur=50; ctx.fillStyle='rgba(0,229,255,0.4)';
    ctx.beginPath(); ctx.arc(impactDot.x,impactDot.y,32,0,Math.PI*2); ctx.fill(); ctx.restore();
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(impactDot.x,impactDot.y,7,0,Math.PI*2); ctx.fill();
  }
  if(ballPos){
    const sz=ballPos.size||14; ctx.fillStyle='rgba(0,0,0,0.15)';
    ctx.beginPath(); ctx.ellipse(ballPos.x,ballPos.y+sz*0.4,sz*0.7,sz*0.2,0,0,Math.PI*2); ctx.fill();
    const bg=ctx.createRadialGradient(ballPos.x-sz*0.25,ballPos.y-sz*0.25,sz*0.1,ballPos.x,ballPos.y,sz);
    bg.addColorStop(0,'#fff'); bg.addColorStop(0.6,'#e8e8e8'); bg.addColorStop(1,'#aaa');
    ctx.fillStyle=bg; ctx.beginPath(); ctx.arc(ballPos.x,ballPos.y,sz,0,Math.PI*2); ctx.fill();
  }
}

function getBallTargets(){
  const g=getGoalGeometry(), cx=g.cx, goalH=g.postBaseY-g.crossbarY;
  return {
    leftCorner: { x: g.bl.x + (g.br.x-g.bl.x)*0.08, y: g.crossbarY + goalH*0.55 },
    rightCorner: { x: g.br.x - (g.br.x-g.bl.x)*0.08, y: g.crossbarY + goalH*0.55 },
    center: { x: cx, y: g.crossbarY + goalH*0.45 },
    overTop: { x: cx + (Math.random()-0.5)*70, y: g.crossbarY - 25 - Math.random()*30 },
    outLeft: { x: g.bl.x - 35 - Math.random()*50, y: g.crossbarY + goalH*(0.2+Math.random()*0.4) },
    outRight: { x: g.br.x + 35 + Math.random()*50, y: g.crossbarY + goalH*(0.2+Math.random()*0.4) }
  };
}

function getRandomMode3Target(){
  const r=Math.random()*100, {out,side}=mode3Chances;
  if(r<out) return ['OUT_TOP','OUT_LEFT','OUT_RIGHT'][Math.floor(Math.random()*3)];
  if(r<out+side) return Math.random()<0.5?'A':'D';
  return 'W';
}

function animateBallMode3(targetType,onDone){
  if(isPaused) return;
  const targets=getBallTargets(), g=getGoalGeometry();
  let endPos;
  switch(targetType){
    case 'A':endPos=targets.leftCorner;break;
    case 'D':endPos=targets.rightCorner;break;
    case 'W':endPos=targets.center;break;
    case 'OUT_TOP':endPos=targets.overTop;break;
    case 'OUT_LEFT':endPos=targets.outLeft;break;
    case 'OUT_RIGHT':endPos=targets.outRight;break;
  }
  roundNeedsSpace = !['OUT_TOP','OUT_LEFT','OUT_RIGHT'].includes(targetType);
  const startX=g.cx, startY=g.horizonY + 20, duration=700, startT=performance.now();
  const impactPos = !roundNeedsSpace ? {x:endPos.x, y:endPos.y} : null;
  function frame(now){
    if(isPaused) return;
    let t=(now-startT)/duration; if(t>1)t=1;
    const ease=1-Math.pow(1-t,3), x=startX+(endPos.x-startX)*ease, y=startY+(endPos.y-startY)*ease, size=4+(22-4)*ease;
    drawMode3Scene({x,y,size}, impactPos);
    if(t<1) m3AnimFrame=requestAnimationFrame(frame); else if(onDone) onDone();
  }
  m3AnimFrame=requestAnimationFrame(frame);
}

let m3SpacePressed=false, m3TimeoutId=null;

function startRound(){
  if(isPaused) return;
  if(attempts>=maxAttempts){showResults();return}
  $('left').classList.remove('active');$('right').classList.remove('active');
  $('ball').style.display = 'none'; $('info').style.opacity = '0'; 
  firstDir = null; firstDirTime = null; spaceTime = null; allKeySegments = []; allSpacePresses = [];

  if(mode===3){
    if(m3AnimFrame) cancelAnimationFrame(m3AnimFrame);
    showIdleBall(); roundStartTime = performance.now(); recording = true; waiting = false;
    m3SpacePressed = false; roundNeedsSpace = false;
    roundTimeout = setTimeout(()=>{
      target = getRandomMode3Target(); signalTime = performance.now(); waiting = true;
      animateBallMode3(target, ()=>{
        if(!roundNeedsSpace){
          m3TimeoutId = setTimeout(()=>{
            if(waiting && !isPaused){ waiting = false; recording = false; finalizeKeys(performance.now()); evaluateMode3(); }
          },1200);
        }
      });
    }, Math.random()*1500 + 600);
    return;
  }

  roundStartTime = performance.now(); recording = true; waiting = false;
  roundTimeout = setTimeout(()=>{
    target = Math.random()<.5 ? 'A' : 'D'; signalTime = performance.now(); waiting = true;
    if(mode===1) $(target==='A'?'left':'right').classList.add('active');
    if(mode===2){
      const b = $('ball'); b.style.display='block'; b.style.left='50%'; b.style.top='0%'; b.style.transition='none';
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        b.style.transition='all 0.35s linear'; b.style.left=target==='A'?'20%':'80%'; b.style.top='80%';
      }));
    }
  }, Math.random()*1500 + 500);
}

document.addEventListener('keydown',e=>{
  if(!recording || e.repeat || isPaused)return;
  const now=performance.now(), code=e.code;
  if((code==='KeyA'||code==='KeyD'||(code==='KeyW'&&mode===3))&&!allKeyDowns[code]){
    allKeyDowns[code]=now;
    if(!firstDir&&waiting){ firstDir=code.replace('Key',''); firstDirTime=now; }
  }
  if(code==='Space'){
    allSpacePresses.push(now);
    if(mode===3&&waiting){
      spaceTime=now; m3SpacePressed=true;
      if(!firstDir){
        if(allKeyDowns['KeyA']) {firstDir='A'; firstDirTime=allKeyDowns['KeyA'];}
        else if(allKeyDowns['KeyD']) {firstDir='D'; firstDirTime=allKeyDowns['KeyD'];}
        else if(allKeyDowns['KeyW']) {firstDir='W'; firstDirTime=allKeyDowns['KeyW'];}
      }
      waiting=false; recording=false; if(m3TimeoutId)clearTimeout(m3TimeoutId);
      finalizeKeys(now); evaluateMode3(); return;
    }
    if(waiting&&!spaceTime){
      spaceTime=now;
      if(!firstDir){
        if(allKeyDowns['KeyA']) {firstDir='A'; firstDirTime=allKeyDowns['KeyA'];}
        else if(allKeyDowns['KeyD']) {firstDir='D'; firstDirTime=allKeyDowns['KeyD'];}
      }
      waiting=false; recording=false; finalizeKeys(now); evaluate();
    }
  }
});

document.addEventListener('keyup',e=>{ if(allKeyDowns[e.code]){ allKeySegments.push({code:e.code,down:allKeyDowns[e.code],up:performance.now()}); delete allKeyDowns[e.code]; }});

function finalizeKeys(endTime){ for(const code of Object.keys(allKeyDowns)) allKeySegments.push({code,down:allKeyDowns[code],up:endTime}); allKeyDowns={}; }

function evaluateMode3(){
  let result, ok=false; const t = i18n[curLang];
  const reaction=spaceTime?Math.round(spaceTime-signalTime):null;
  if(!roundNeedsSpace){
    if(m3SpacePressed) result=t.errJumpOnOut; else { ok=true; result=t.okOut; }
  } else {
    if(!m3SpacePressed) result=t.errNoJump;
    else if(!firstDir) result=t.errSpaceOnly;
    else if(spaceTime+tolerance<firstDirTime) result=t.errEarlySpace;
    else if(firstDir!==target) result=t.errWrongSide;
    else { ok=true; if(reaction!==null)reactions.push(reaction); result=`${reaction} ${t.ms}`; }
  }
  processResult(ok, result, reaction);
}

function evaluate(){
  let result, ok=false; const t = i18n[curLang];
  if(!firstDir) result=t.errSpaceOnly;
  else if(spaceTime+tolerance<firstDirTime) result=t.errEarlySpace;
  else if(firstDir!==target) result=t.errWrongSide;
  else { const r=Math.round(spaceTime-signalTime); reactions.push(r); result=`${r} ${t.ms}`; ok=true; }
  processResult(ok, result, ok?Math.round(spaceTime-signalTime):null);
}

function processResult(ok, result, reactionMs){
  const dot=$('dot'+attempts); if(dot){dot.classList.remove('current'); dot.classList.add(ok?'success':'fail')}
  const t = i18n[curLang];
  let targetLabel = {A:t.tL, D:t.tR, W:t.tC, OUT_TOP:t.tOT, OUT_LEFT:t.tOL, OUT_RIGHT:t.tOR}[target];
  roundData.push({attempt:attempts+1, target, firstDir, ok, result, reactionMs, signalRel:signalTime-roundStartTime, spaceRel:spaceTime?spaceTime-roundStartTime:null, allSpaceRel:allSpacePresses.map(tm=>tm-roundStartTime), segments:allKeySegments.map(s=>({code:s.code,down:s.down-roundStartTime,up:s.up-roundStartTime})), targetLabel});
  const infoEl = $('info'); infoEl.textContent = (ok ? '✅ ' : '❌ ') + result; infoEl.style.opacity = '1'; infoEl.style.color = ok ? '#00e676' : '#ff3d71';
  attempts++; roundTimeout = setTimeout(startRound, mode===3?1100:900);
}

function showResults(){
  $('pauseBtn').style.display='none'; $('info').style.opacity='0'; if(mode===3)$('mode3Area').style.display='none';
  $('resultsOverlay').classList.add('show');
  const t = i18n[curLang];
  let avg=reactions.length?Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length)+' '+t.ms:'—';
  let html=`<div class="res-title">${t.results}</div><div class="res-avg">${t.avgReaction}: ${avg}</div>`;
  for(const rd of roundData) html+=buildRoundCard(rd);
  html+=`<div class="btn-row"><button class="restart-btn" onclick="restartSameMode()">${t.restart}</button><button class="back-btn" onclick="backToMenu()">${t.back}</button></div>`;
  $('resultsContent').innerHTML=html;
}

function buildRoundCard(rd){
  const sig=rd.signalRel, t=i18n[curLang];
  let maxT=sig+200, minT=0;
  for(const s of rd.segments) maxT=Math.max(maxT,s.up), minT=Math.min(minT,s.down);
  if(rd.spaceRel) maxT=Math.max(maxT,rd.spaceRel);
  const range=maxT-minT+60, toP=tm=>((tm-minT+30)/range*100);
  let inner=`<div class="tl-prezone" style="left:0;width:${toP(sig)}%"></div><div class="tl-signal-line" style="left:${toP(sig)}%"></div><div class="tl-marker signal-mk" style="left:${toP(sig)}%"></div>`;
  for(const s of rd.segments){
    const cls={KeyA:'key-a',KeyD:'key-d',KeyW:'key-w'}[s.code];
    if(cls) inner+=`<div class="tl-bar ${cls}" style="left:${toP(s.down)}%;width:${Math.max(toP(s.up)-toP(s.down),0.5)}%;top:calc(50% + ${{KeyA:-14,KeyW:-2,KeyD:10}[s.code]}px)"></div>`;
  }
  for(const tm of rd.allSpaceRel) inner+=`<div class="tl-marker space-mk" style="left:${toP(tm)}%"></div>`;
  return `<div class="round-card">
    <div class="round-header"><span class="round-num">${t.round} ${rd.attempt} · ${t.goal}: ${rd.targetLabel}</span><span class="round-result ${rd.ok?'ok':'err'}">${rd.ok?'✅ '+(rd.reactionMs?rd.reactionMs+' '+t.ms:t.okLabel):'❌ '+rd.result}</span></div>
    <div class="timeline-wrap"><div class="tl-axis"></div>${inner}</div>
  </div>`;
}

window.restartSameMode=()=>{ resetGame(); $('pauseBtn').style.display='block'; if(mode===3){$('mode3Area').style.display='block';initMode3Canvas();} startRound(); }
window.backToMenu=()=>{ if(roundTimeout) clearTimeout(roundTimeout); resetGame(); $('pauseBtn').style.display='none'; $('langSelector').style.display='block'; $('mode3Area').style.display='none'; $('gameArea').style.display='flex'; $('menu').style.display='flex'; }

const outR = $('outRange'), sideR = $('sideRange'), centerR = $('centerRange');
function updatePercents(){
  let o = +outR.value, s = +sideR.value, c = +centerR.value, sum = o + s + c || 1;
  o = Math.round(o/sum*100); s = Math.round(s/sum*100); c = 100-o-s;
  $('pOut').textContent = o; $('pSide').textContent = s; $('pCenter').textContent = c;
  mode3Chances = { out: o, side: s, center: c };
}
[outR, sideR, centerR].forEach(r => r.addEventListener('input', updatePercents));
updatePercents();
$('startMode3').onclick = () => { $('mode3Settings').style.display = 'none'; startGame(3); };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Reaction Test ‚Äî DUEL</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{ --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f; --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00; }

#menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;z-index:1000}
#menu h1{font-size:42px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

.menu-btn{ padding:16px 36px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700; border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff; cursor:pointer;transition:all .2s;min-width:280px; }
.menu-btn:hover{border-color:var(--accent);box-shadow:0 0 24px rgba(0,229,255,.15);transform:translateY(-2px)}
.menu-btn span{color:#888;font-weight:300;font-size:14px;display:block;margin-top:4px}

#gameArea{flex:1;display:flex;position:relative;overflow:hidden}
.side{flex:1;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;font-family:'JetBrains Mono',monospace;opacity:.06;transition:all .15s;user-select:none}
.side.active{opacity:1;color:#000}
#left.active{background:var(--accent)}
#right.active{background:var(--accent)}
#ball{position:absolute;width:36px;height:36px;border-radius:50%;background:#fff;left:50%;top:0%;transform:translate(-50%,0%);display:none;z-index:10}

#hudWrapper{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:50;display:flex;flex-direction:column;align-items:center;gap:10px}
#duelScore{display:none; font-family:'JetBrains Mono',monospace; font-size:24px; font-weight:900; background:rgba(0,0,0,0.8); padding:8px 20px; border-radius:12px; border:2px solid var(--purple); color:#fff; white-space:nowrap;}
#hud{display:flex;gap:8px;justify-content:center;}

.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333;transition:all .3s}
.dot.success{background:var(--success);border-color:var(--success)}
.dot.fail{background:var(--fail);border-color:var(--fail)}
.dot.draw{background:var(--warn);border-color:var(--warn)}
.dot.current{border-color:var(--accent)}

#info{position:fixed;bottom:20%;width:100%;text-align:center;font-size:24px;font-weight:700;font-family:'JetBrains Mono',monospace;z-index:50}

#resultsOverlay{position:fixed;inset:0;background:rgba(10,10,15,0.98);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
#resultsOverlay.show{display:flex}

#mode3Area{position:fixed;inset:0;display:none;z-index:40}
#mode3Canvas{width:100%;height:100%}

/* LOBBY */
#duelLobby{position:fixed;inset:0;z-index:1600;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;}
.lobby-card{background:var(--card); border:2px solid var(--border); border-radius:20px; padding:40px; width:450px; text-align:center;}
#duelLinkInput{width:100%; padding:12px; margin:20px 0; background:#000; border:1px solid var(--accent); color:var(--accent); font-family:monospace; border-radius:8px;}
.back-btn{background:none; border:none; color:#666; cursor:pointer; text-decoration:underline; margin-top:20px}
</style>
</head>
<body>

<div id="duelLobby">
    <div class="lobby-card">
        <h2 id="lobbyTitle">–°–æ–∑–¥–∞–Ω–∏–µ –¥—É—ç–ª–∏</h2>
        <p id="lobbyDesc">–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</p>
        <input type="text" id="duelLinkInput" readonly>
        <div id="lobbyStatus" style="color:var(--warn)">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
        <button class="back-btn" onclick="location.href=location.pathname">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="menu">
    <h1>GK Reaction Test</h1>
    <button class="menu-btn" onclick="startGame(1)">–†–µ–∂–∏–º 1 <span>–°–∏–≥–Ω–∞–ª</span></button>
    <button class="menu-btn" onclick="startGame(2)">–†–µ–∂–∏–º 2 <span>–ú—è—á –≤ —É–≥–æ–ª</span></button>
    <button class="menu-btn" onclick="startGame(3)">–†–µ–∂–∏–º 3 <span>3D –í–æ—Ä–æ—Ç–∞ (–°–æ–ª–æ)</span></button>
    <button class="menu-btn" id="mode4btn" style="border-color:var(--purple)">–†–µ–∂–∏–º 4 ‚Äî –î—É—ç–ª—å 1x1<span>15 –æ–±—â–∏—Ö —Ä–∞—É–Ω–¥–æ–≤</span></button>
</div>

<div id="hudWrapper">
    <div id="duelScore">YOU 0 : 0 OPP</div>
    <div id="hud"></div>
</div>

<div id="gameArea">
    <div id="left" class="side">A</div>
    <div id="right" class="side">D</div>
    <div id="ball"></div>
</div>

<div id="info"></div>

<div id="mode3Area"><canvas id="mode3Canvas"></canvas></div>

<div id="resultsOverlay">
    <h1 id="resTitle" style="font-size:48px; margin-bottom:20px"></h1>
    <h2 id="resScore" style="color:var(--accent); margin-bottom:40px"></h2>
    <button class="menu-btn" onclick="location.reload()">–í –º–µ–Ω—é</button>
</div>

<script>
const $=id=>document.getElementById(id);
let mode=1, attempts=0, maxAttempts=5;
let target=null, signalTime=0, waiting=false, recording=false;
let roundStartTime=0, spaceTime=null, firstDir=null;
let reactions=[];

// PeerJS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let peer, conn, isHost=false, duelTargets=[];
let myScore=0, oppScore=0;
let myRoundDone=false, oppRoundDone=false;
let myResultData=null, oppResultData=null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 3D —Å—Ü–µ–Ω—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
const M3={ctx:null,W:0,H:0};
function initM3(){
    const c=$('mode3Canvas'); M3.ctx=c.getContext('2d');
    M3.W=c.width=window.innerWidth; M3.H=c.height=window.innerHeight;
}

window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('duel');
    if(joinId) joinDuel(joinId);
};

$('mode4btn').onclick = hostDuel;

function hostDuel() {
    isHost = true;
    $('menu').style.display='none';
    $('duelLobby').style.display='flex';
    peer = new Peer();
    peer.on('open', id => {
        const link = window.location.origin + window.location.pathname + '?duel=' + id;
        $('duelLinkInput').value = link;
        // –ö–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä
        navigator.clipboard.writeText(link);
        $('lobbyStatus').textContent = "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –ñ–¥–µ–º –¥—Ä—É–≥–∞...";
    });
    peer.on('connection', c => {
        conn = c;
        setupConnection();
    });
}

function joinDuel(id) {
    isHost = false;
    $('menu').style.display='none';
    $('duelLobby').style.display='flex';
    $('lobbyTitle').textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
    $('lobbyDesc').textContent = "–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å —Ö–æ—Å—Ç–æ–º...";
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(id);
        setupConnection();
    });
}

function setupConnection() {
    conn.on('open', () => {
        if(isHost) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 15 —Ä–∞—É–Ω–¥–æ–≤ –∑–∞—Ä–∞–Ω–µ–µ
            duelTargets = Array.from({length:15}, () => ['A','D','W','OUT'][Math.floor(Math.random()*4)]);
            conn.send({type:'START', targets: duelTargets});
            startDuelGame();
        }
    });
    conn.on('data', data => {
        if(data.type === 'START') {
            duelTargets = data.targets;
            startDuelGame();
        }
        if(data.type === 'RESULT') {
            oppResultData = data.result;
            oppRoundDone = true;
            checkRoundEnd();
        }
    });
}

function startDuelGame() {
    $('duelLobby').style.display='none';
    $('duelScore').style.display='block';
    maxAttempts = 15;
    mode = 4;
    initM3();
    buildHud();
    startRound();
}

function buildHud() {
    $('hud').innerHTML = Array.from({length:maxAttempts}, (_,i)=>`<div class="dot" id="dot${i}"></div>`).join('');
}

function startRound() {
    if(attempts >= maxAttempts) return endDuel();
    
    myRoundDone = false; oppRoundDone = false;
    myResultData = null; oppResultData = null;
    waiting = false; recording = true;
    firstDir = null; spaceTime = null;
    
    $('info').textContent = "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...";
    $('info').style.color = "#888";
    
    setTimeout(() => {
        target = duelTargets[attempts];
        signalTime = performance.now();
        waiting = true;
        $('info').textContent = "–ñ–ú–ò!";
        $('info').style.color = "var(--accent)";
    }, 1000 + Math.random()*2000);
}

document.addEventListener('keydown', e => {
    if(!waiting || myRoundDone) return;
    const now = performance.now();
    
    if(['KeyA','KeyD','KeyW'].includes(e.code)) {
        firstDir = e.code.replace('Key','');
    }
    
    if(e.code === 'Space') {
        spaceTime = now;
        myRoundDone = true;
        const reaction = Math.round(spaceTime - signalTime);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ (–≤ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ —É–ø—Ä–æ—â–µ–Ω–æ)
        let isOk = (firstDir === target) || (target === 'OUT' && !firstDir);
        if(target === 'OUT' && spaceTime) isOk = false; // –ü—Ä—ã–≥–Ω—É–ª, –∫–æ–≥–¥–∞ –Ω–µ –Ω–∞–¥–æ

        myResultData = { ok: isOk, time: reaction };
        conn.send({type:'RESULT', result: myResultData});
        
        $('info').textContent = "–ñ–¥–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
        checkRoundEnd();
    }
});

function checkRoundEnd() {
    if(myRoundDone && oppRoundDone) {
        const dot = $('dot' + attempts);
        let win = false, draw = false;

        // –õ–û–ì–ò–ö–ê –°–†–ê–í–ù–ï–ù–ò–Ø (–∫–∞–∫ –≤ –∑–∞–ø—Ä–æ—Å–µ)
        if(myResultData.ok && oppResultData.ok) {
            if(myResultData.time < oppResultData.time) { myScore++; win=true; }
            else if(oppResultData.time < myResultData.time) { oppScore++; }
            else { myScore++; oppScore++; draw=true; } // –ù–∏—á—å—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        } else if (myResultData.ok && !oppResultData.ok) {
            myScore++; win=true;
        } else if (!myResultData.ok && oppResultData.ok) {
            oppScore++;
        } else {
            myScore++; oppScore++; draw=true; // –û–±–∞ –æ—à–∏–±–ª–∏—Å—å
        }

        if(win) dot.classList.add('success');
        else if(draw) dot.classList.add('draw');
        else dot.classList.add('fail');

        $('duelScore').textContent = `YOU ${myScore} : ${oppScore} OPP`;
        attempts++;
        setTimeout(startRound, 1500);
    }
}

function endDuel() {
    $('resultsOverlay').classList.add('show');
    if(myScore > oppScore) $('resTitle').textContent = "–ü–û–ë–ï–î–ê! üèÜ";
    else if(myScore < oppScore) $('resTitle').textContent = "–ü–û–†–ê–ñ–ï–ù–ò–ï üíÄ";
    else $('resTitle').textContent = "–ù–ò–ß–¨–Ø ü§ù";
    $('resScore').textContent = `${myScore} : ${oppScore}`;
}

// –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥
function startGame(m) {
    mode = m;
    $('menu').style.display='none';
    if(m===3) { $('mode3Area').style.display='block'; initM3(); }
    maxAttempts = 5;
    buildHud();
    startRound();
}
</script>
</body>
</html>

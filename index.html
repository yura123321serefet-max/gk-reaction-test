<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Reaction Test ‚Äî DUEL 3D</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
    :root{ --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f; --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00; }

    /* –ú–µ–Ω—é */
    #menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:1000}
    #menu h1{font-size:42px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:20px}
    .menu-btn{ padding:16px 36px;font-size:18px;font-weight:700; border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff; cursor:pointer;transition:all .2s;min-width:300px; }
    .menu-btn:hover{border-color:var(--accent);transform:translateY(-2px)}

    /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
    #gameArea{flex:1;position:relative;display:flex;align-items:center;justify-content:center;background:#0f0f1a;overflow:hidden;}
    #goal{position:relative;width:600px;height:300px;border:8px solid #fff;border-bottom:none;box-shadow:0 0 50px rgba(255,255,255,0.1);z-index:1}
    #ball{position:absolute;width:50px;height:50px;background:#fff;border-radius:50%;bottom:20px;left:50%;transform:translateX(-50%);transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);display:none;z-index:10;box-shadow:0 0 20px #fff}

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–æ—Ä–æ–Ω (–¥–ª—è –≤–∏–∑—É–∞–ª–∞ –†–µ–∂–∏–º–∞ 3) */
    .target-hint{position:absolute;font-size:80px;font-weight:900;color:var(--accent);opacity:0;transition:0.1s;z-index:5}
    .hint-a{left:50px;top:50%}
    .hint-d{right:50px;top:50%}
    .hint-w{top:20px;left:50%;transform:translateX(-50%)}

    /* HUD */
    #hudWrapper{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:50;display:flex;flex-direction:column;align-items:center;gap:15px}
    #duelScore{display:none; font-family:'JetBrains Mono',monospace; font-size:24px; font-weight:900; background:rgba(0,0,0,0.8); padding:8px 25px; border-radius:12px; border:2px solid var(--purple); color:#fff;}
    #hud{display:flex;gap:8px;}
    .dot{width:14px;height:14px;border-radius:50%;border:2px solid #333;background:#222}
    .dot.success{background:var(--success);border-color:var(--success)}
    .dot.fail{background:var(--fail);border-color:var(--fail)}
    .dot.draw{background:var(--warn);border-color:var(--warn)}
    .dot.current{border-color:var(--accent);box-shadow:0 0 10px var(--accent)}

    #info{position:fixed;bottom:20%;width:100%;text-align:center;font-size:28px;font-weight:700;z-index:50;text-transform:uppercase}

    /* –õ–æ–±–±–∏ */
    #duelLobby{position:fixed;inset:0;z-index:1600;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;}
    .lobby-card{background:var(--card); border:2px solid var(--border); border-radius:20px; padding:40px; width:450px; text-align:center;}
    #duelLinkInput{width:100%; padding:12px; margin:20px 0; background:#000; border:1px solid var(--accent); color:var(--accent); font-family:monospace; border-radius:8px; text-align:center}

    #resultsOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;}
    #resultsOverlay.show{display:flex}
</style>
</head>
<body>

<div id="duelLobby">
    <div class="lobby-card">
        <h2 id="lobbyTitle">–î—É—ç–ª—å –†–µ–∂–∏–º 3</h2>
        <p id="lobbyDesc">–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É (–æ–Ω–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞):</p>
        <input type="text" id="duelLinkInput" readonly>
        <div id="lobbyStatus" style="color:var(--warn)">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
        <button class="menu-btn" style="min-width:auto;margin-top:20px" onclick="location.href=location.pathname">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="menu">
    <h1>GK Reaction Test</h1>
    <button class="menu-btn" onclick="location.reload()">–û–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º</button>
    <button class="menu-btn" id="mode4btn" style="border-color:var(--purple)">–†–ï–ñ–ò–ú 4: –î–£–≠–õ–¨ (3D)<span>15 —Ä–∞—É–Ω–¥–æ–≤ 1x1</span></button>
</div>

<div id="hudWrapper">
    <div id="duelScore">–í–´ 0 : 0 –û–ü–ü</div>
    <div id="hud"></div>
</div>

<div id="gameArea">
    <div id="goal"></div>
    <div id="ball"></div>
    <div id="hint-A" class="target-hint hint-a">A</div>
    <div id="hint-D" class="target-hint hint-d">D</div>
    <div id="hint-W" class="target-hint hint-w">W</div>
</div>

<div id="info"></div>

<div id="resultsOverlay">
    <h1 id="resTitle" style="font-size:60px;margin-bottom:10px"></h1>
    <h2 id="resScore" style="color:var(--accent);font-size:40px;margin-bottom:30px"></h2>
    <button class="menu-btn" onclick="location.reload()">–í –º–µ–Ω—é</button>
</div>

<script>
const $=id=>document.getElementById(id);
let attempts=0, maxAttempts=15;
let target=null, signalTime=0, canReact=false;
let myScore=0, oppScore=0;
let peer, conn, isHost=false, duelTargets=[];
let myRoundDone=false, oppRoundDone=false;
let myResultData=null, oppResultData=null;

window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('duel');
    if(joinId) joinDuel(joinId);
};

$('mode4btn').onclick = hostDuel;

function hostDuel() {
    isHost = true;
    $('menu').style.display='none';
    $('duelLobby').style.display='flex';
    peer = new Peer();
    peer.on('open', id => {
        const link = window.location.origin + window.location.pathname + '?duel=' + id;
        $('duelLinkInput').value = link;
        navigator.clipboard.writeText(link);
        $('lobbyStatus').textContent = "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –ñ–¥–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
    });
    peer.on('connection', c => { conn = c; setupConnection(); });
}

function joinDuel(id) {
    isHost = false;
    $('menu').style.display='none';
    $('duelLobby').style.display='flex';
    $('lobbyTitle').textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
    peer = new Peer();
    peer.on('open', () => { conn = peer.connect(id); setupConnection(); });
}

function setupConnection() {
    conn.on('open', () => {
        if(isHost) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 15 —Ä–∞—É–Ω–¥–æ–≤: A, D, W –∏–ª–∏ OUT (–º–∏–º–æ)
            const types = ['A','D','W','OUT'];
            duelTargets = Array.from({length:15}, () => types[Math.floor(Math.random()*4)]);
            conn.send({type:'START', targets: duelTargets});
            startDuelGame();
        }
    });
    conn.on('data', data => {
        if(data.type === 'START') { duelTargets = data.targets; startDuelGame(); }
        if(data.type === 'RESULT') { oppResultData = data.result; oppRoundDone = true; checkRoundEnd(); }
    });
}

function startDuelGame() {
    $('duelLobby').style.display='none';
    $('duelScore').style.display='block';
    buildHud();
    startRound();
}

function buildHud() {
    $('hud').innerHTML = Array.from({length:maxAttempts}, (_,i)=>`<div class="dot" id="dot${i}"></div>`).join('');
}

function startRound() {
    if(attempts >= maxAttempts) return endDuel();
    
    myRoundDone = false; oppRoundDone = false;
    myResultData = null; oppResultData = null;
    canReact = false;
    
    // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª–∞
    $('ball').style.display = 'none';
    $('ball').style.bottom = '20px';
    $('ball').style.left = '50%';
    document.querySelectorAll('.target-hint').forEach(el => el.style.opacity = '0');
    $('dot' + attempts).classList.add('current');
    
    $('info').textContent = "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...";
    $('info').style.color = "#888";
    
    setTimeout(() => {
        target = duelTargets[attempts];
        signalTime = performance.now();
        canReact = true;
        
        $('ball').style.display = 'block';
        $('info').textContent = "–†–ï–ê–ì–ò–†–£–ô!";
        $('info').style.color = "#fff";

        // –ê–Ω–∏–º–∞—Ü–∏—è –º—è—á–∞
        setTimeout(() => {
            if(target === 'A') { $('ball').style.left = '10%'; $('ball').style.bottom = '250px'; $('hint-A').style.opacity='1'; }
            if(target === 'D') { $('ball').style.left = '90%'; $('ball').style.bottom = '250px'; $('hint-D').style.opacity='1'; }
            if(target === 'W') { $('ball').style.left = '50%'; $('ball').style.bottom = '280px'; $('hint-W').style.opacity='1'; }
            if(target === 'OUT') { $('ball').style.left = '110%'; $('ball').style.bottom = '400px'; $('info').textContent = "–ú–ò–ú–û!"; }
        }, 50);

        // –ê–≤—Ç–æ-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –µ—Å–ª–∏ –º—è—á "OUT" –∏ –∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–∂–∞–ª
        if(target === 'OUT') {
            setTimeout(() => { if(!myRoundDone) finishMyRound(true, 0); }, 1000);
        }
    }, 1500 + Math.random() * 2000);
}

document.addEventListener('keydown', e => {
    if(!canReact || myRoundDone) return;
    
    let keyMap = {'KeyA':'A', 'KeyD':'D', 'KeyW':'W'};
    let pressed = keyMap[e.code];
    
    if(pressed) {
        const time = Math.round(performance.now() - signalTime);
        const isCorrect = (pressed === target);
        finishMyRound(isCorrect, time);
    }
});

function finishMyRound(isCorrect, time) {
    myRoundDone = true;
    myResultData = { ok: isCorrect, time: time };
    conn.send({type:'RESULT', result: myResultData});
    $('info').textContent = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
    checkRoundEnd();
}

function checkRoundEnd() {
    if(myRoundDone && oppRoundDone) {
        const dot = $('dot' + attempts);
        let result = 'draw';

        // –õ–æ–≥–∏–∫–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
        // 1. –û–±–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ -> –∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ
        if(myResultData.ok && oppResultData.ok) {
            if(myResultData.time < oppResultData.time || target === 'OUT') { myScore++; result='success'; }
            else if(oppResultData.time < myResultData.time) { oppScore++; result='fail'; }
            else { myScore++; oppScore++; result='draw'; }
        } 
        // 2. –û–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –¥—Ä—É–≥–æ–π –Ω–µ—Ç
        else if(myResultData.ok && !oppResultData.ok) { myScore++; result='success'; }
        else if(!myResultData.ok && oppResultData.ok) { oppScore++; result='fail'; }
        // 3. –û–±–∞ –æ—à–∏–±–ª–∏—Å—å
        else { myScore++; oppScore++; result='draw'; }

        dot.className = 'dot ' + result;
        $('duelScore').textContent = `–í–´ ${myScore} : ${oppScore} –û–ü–ü`;
        
        attempts++;
        setTimeout(startRound, 2000);
    }
}

function endDuel() {
    $('resultsOverlay').classList.add('show');
    if(myScore > oppScore) $('resTitle').textContent = "–ü–û–ë–ï–î–ê! üèÜ";
    else if(myScore < oppScore) $('resTitle').textContent = "–ü–†–û–ò–ì–†–´–® üíÄ";
    else $('resTitle').textContent = "–ù–ò–ß–¨–Ø ü§ù";
    $('resScore').textContent = `${myScore} : ${oppScore}`;
}
</script>
</body>
</html>

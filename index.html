<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rematch GK Reaction Test - Duel Edition</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{
  --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f;
  --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00;
}

#menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:1000}
#menu h1{font-size:42px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#menu p{color:#888;font-size:14px;max-width:420px;text-align:center;line-height:1.6}
.menu-btn{
  padding:16px 36px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700;
  border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff;
  cursor:pointer;transition:all .2s;min-width:280px;
}
.menu-btn:hover{border-color:var(--accent);box-shadow:0 0 24px rgba(0,229,255,.15);transform:translateY(-2px)}
.menu-btn span{color:#888;font-weight:300;font-size:14px;display:block;margin-top:4px}

#gameArea{flex:1;display:flex;position:relative;overflow:hidden}
.side{flex:1;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;font-family:'JetBrains Mono',monospace;opacity:.06;transition:all .15s;user-select:none;letter-spacing:4px}
.side.active{opacity:1;color:#000}
#left.active{background:var(--accent)}
#right.active{background:var(--accent)}

#ball{position:absolute;width:36px;height:36px;border-radius:50%;background:#fff;left:50%;top:0%;transform:translate(-50%,0%);display:none;box-shadow:0 0 20px rgba(255,255,255,.5);z-index:10}

#hud{position:fixed;top:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:50;flex-wrap:wrap;justify-content:center;max-width:90vw}
.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333;transition:all .3s}
.dot.success{background:var(--success);border-color:var(--success);box-shadow:0 0 8px var(--success)}
.dot.fail{background:var(--fail);border-color:var(--fail);box-shadow:0 0 8px var(--fail)}
.dot.current{border-color:var(--accent);box-shadow:0 0 8px var(--accent)}

#info{position:fixed;bottom:16px;width:100%;text-align:center;font-size:16px;font-family:'JetBrains Mono',monospace;color:#888;z-index:50;pointer-events:none}

#resultsOverlay{position:fixed;inset:0;background:rgba(10,10,15,.97);z-index:2000;display:none;flex-direction:column;align-items:center;overflow-y:auto;padding:40px 20px}
#resultsOverlay.show{display:flex}
#resultsContent{max-width:720px;width:100%}
.res-title{font-size:36px;font-weight:900;text-align:center;margin-bottom:8px;letter-spacing:-1px}
.res-avg{text-align:center;font-size:20px;color:var(--accent);font-family:'JetBrains Mono',monospace;margin-bottom:32px}

.round-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:16px}
.round-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:4px}
.round-num{font-weight:700;font-size:14px;color:#888}
.round-result{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.round-result.ok{color:var(--success)}
.round-result.err{color:var(--fail)}

.timeline-wrap{position:relative;height:64px;background:#0d0d18;border-radius:8px;overflow:hidden;border:1px solid #1a1a2a}
.tl-axis{position:absolute;top:50%;left:0;right:0;height:1px;background:#222}
.tl-signal-line{position:absolute;top:0;bottom:0;width:2px;background:rgba(255,255,255,.25);z-index:2}
.tl-label{position:absolute;bottom:2px;font-size:9px;font-family:'JetBrains Mono',monospace;color:#555;z-index:3;transform:translateX(-50%)}
.tl-label.top{bottom:auto;top:2px}
.tl-bar{position:absolute;height:10px;border-radius:3px;z-index:4;opacity:.85;min-width:3px}
.tl-bar.key-a{background:var(--accent)}
.tl-bar.key-d{background:var(--purple)}
.tl-bar.key-w{background:var(--success)}
.tl-marker{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;transform:translate(-50%,-50%);z-index:6}
.tl-marker.signal-mk{background:#fff;box-shadow:0 0 8px #fff}
.tl-marker.space-mk{background:var(--warn);box-shadow:0 0 6px var(--warn)}
.tl-prezone{position:absolute;top:0;bottom:0;background:rgba(255,255,255,.03);z-index:1;border-right:1px dashed rgba(255,255,255,.12)}

.btn-row{display:flex;flex-direction:column;align-items:center;margin-top:32px;gap:10px;padding-bottom:40px}
.restart-btn{
  padding:16px 48px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700;
  border:2px solid var(--accent);border-radius:12px;background:transparent;color:var(--accent);
  cursor:pointer;transition:all .2s;
}
.restart-btn:hover{background:var(--accent);color:#000}
.back-btn{
  padding:12px 32px;font-size:14px;font-family:'Outfit',sans-serif;font-weight:500;
  border:1px solid var(--border);border-radius:8px;background:transparent;color:#888;
  cursor:pointer;transition:all .2s;
}
.back-btn:hover{border-color:#888;color:#fff}

#mode3Area{position:fixed;inset:0;display:none;overflow:hidden;z-index:40}
#mode3Canvas{width:100%;height:100%;display:block}
.sliderRow{margin-bottom:16px;}
.sliderRow label{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px;color:#aaa;}
.sliderRow input{width:100%;}

/* Лобби для Дуэли */
#lobbyOverlay{position:fixed;inset:0;z-index:1600;background:rgba(10,10,15,.98);display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
#lobbyOverlay h2{font-size:32px;margin-bottom:20px;color:#fff}
#shareUrl{background:var(--card);border:1px solid var(--border);color:var(--accent);padding:12px;width:350px;border-radius:8px;text-align:center;font-family:monospace;margin-bottom:20px;outline:none}

</style>
</head>

<body>

<div id="mode3Settings" style="position:fixed;inset:0;z-index:1500;background:rgba(10,10,15,.97);display:none;align-items:center;justify-content:center;">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;width:420px;max-width:90vw;">
    <h2 style="font-size:28px;margin-bottom:16px">Настройка ударов</h2>
    <div class="sliderRow"><label>Мимо ворот: <b><span id="pOut">30</span>%</b></label><input type="range" min="0" max="100" value="30" id="outRange"></div>
    <div class="sliderRow"><label>В створ (углы): <b><span id="pSide">50</span>%</b></label><input type="range" min="0" max="100" value="50" id="sideRange"></div>
    <div class="sliderRow"><label>По центру: <b><span id="pCenter">20</span>%</b></label><input type="range" min="0" max="100" value="20" id="centerRange"></div>
    <button class="menu-btn" style="margin-top:20px" id="startMode3">ОК<span>Запустить режим</span></button>
  </div>
</div>

<div id="lobbyOverlay">
  <h2 id="lobbyStatus">Создание комнаты...</h2>
  <p style="color:#888;margin-bottom:10px;">Отправь эту ссылку другу:</p>
  <input type="text" id="shareUrl" readonly>
  <p id="lobbyWaitText" style="color:var(--warn);font-size:14px;margin-bottom:20px;">Ожидаем подключения второго игрока...</p>
  <button class="back-btn" onclick="location.href=window.location.pathname">Отмена</button>
</div>

<div id="menu">
  <h1>GK Reaction Test</h1>
  <p>Нажми <b>A</b> или <b>D</b> чтобы выбрать сторону, затем <b>SPACE</b> чтобы прыгнуть. В 3D режиме доступна кнопка <b>W</b> (центр).</p>
  <button class="menu-btn" id="mode1">Режим 1 — Сигнал<span>Сторона подсвечивается</span></button>
  <button class="menu-btn" id="mode2">Режим 2 — Мяч<span>Мяч летит в угол</span></button>
  <button class="menu-btn" id="mode3btn">Режим 3 — Ворота 3D<span>Мяч летит на тебя · 15 раундов</span></button>
  <button class="menu-btn" id="modeDuel" style="border-color:var(--purple)">Режим 4 — Дуэль<span>Игра против друга по сети (15 раундов)</span></button>
</div>

<div id="hud"></div>
<div id="gameArea">
  <div id="left" class="side">A</div>
  <div id="right" class="side">D</div>
  <div id="ball"></div>
</div>
<div id="info"></div>

<div id="mode3Area">
  <canvas id="mode3Canvas"></canvas>
</div>

<div id="resultsOverlay">
  <div id="resultsContent"></div>
</div>

<script>
// --- GLOBAL VARIABLES ---
let mode3Chances = { out: 30, side: 50, center: 20 };
const $=id=>document.getElementById(id);
let mode=1, attempts=0, maxAttempts=5;
let target=null, signalTime=0, roundStartTime=0;
let waiting=false, recording=false;
let firstDir=null, firstDirTime=null, spaceTime=null;
let allKeyDowns={}, allKeySegments=[], allSpacePresses=[];
let roundData=[], reactions=[];
const tolerance=20;
let roundNeedsSpace=false;

// --- MULTIPLAYER (PEERJS) VARIABLES ---
let peer = null, conn = null, isHost = false;
let opponentResults = null, duelSequence = [];
let myDuelScore = 0, opponentDuelScore = 0;

// --- INITIALIZATION ---
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get('room');
  if (roomId) joinRoom(roomId);
});

$('modeDuel').onclick = createRoom;

function createRoom() {
  isHost = true;
  peer = new Peer();
  $('lobbyOverlay').style.display = 'flex';
  peer.on('open', (id) => {
    const url = window.location.origin + window.location.pathname + '?room=' + id;
    $('shareUrl').value = url;
    $('lobbyStatus').textContent = 'Лобби создано';
  });
  peer.on('connection', (connection) => {
    conn = connection;
    setupConn();
  });
}

function joinRoom(id) {
  isHost = false;
  peer = new Peer();
  $('lobbyOverlay').style.display = 'flex';
  $('lobbyStatus').textContent = 'Подключение...';
  peer.on('open', () => {
    conn = peer.connect(id);
    setupConn();
  });
}

function setupConn() {
  conn.on('open', () => {
    $('lobbyStatus').textContent = 'Соединение установлено!';
    if (isHost) {
      duelSequence = Array.from({length: 15}, getRandomMode3Target);
      conn.send({ type: 'START_GAME', sequence: duelSequence });
      startDuelGame();
    }
  });
  conn.on('data', (data) => {
    if (data.type === 'START_GAME') {
      duelSequence = data.sequence;
      startDuelGame();
    }
    if (data.type === 'GAME_OVER') {
      opponentResults = data.results;
      checkDuelEnd();
    }
  });
}

function startDuelGame() {
  setTimeout(() => {
    $('lobbyOverlay').style.display = 'none';
    mode = 4;
    maxAttempts = 15;
    $('menu').style.display = 'none';
    $('gameArea').style.display = 'none';
    $('mode3Area').style.display = 'block';
    initMode3Canvas();
    resetGame();
    startRound();
  }, 1000);
}

// --- GAME CORE ---
function resetGame(){
  attempts=0;roundData=[];reactions=[]; opponentResults = null;
  $('hud').innerHTML='';$('info').textContent='';
  $('resultsOverlay').classList.remove('show');
  $('left').classList.remove('active');$('right').classList.remove('active');
  $('ball').style.display='none';
  recording=false;waiting=false;
  buildHud();
}

function buildHud(){
  let h='';for(let i=0;i<maxAttempts;i++) h+=`<div class="dot" id="dot${i}"></div>`;
  $('hud').innerHTML=h;
}

function startGame(m){
  mode=m;
  maxAttempts = (mode>=3) ? 15 : 5;
  $('menu').style.display='none';
  if(mode>=3){
    $('gameArea').style.display='none';
    $('mode3Area').style.display='block';
    initMode3Canvas();
  } else {
    $('gameArea').style.display='flex';
    $('mode3Area').style.display='none';
  }
  resetGame();
  startRound();
}

$('mode1').onclick=()=>startGame(1);
$('mode2').onclick=()=>startGame(2);
$('mode3btn').onclick=()=>{
  $('menu').style.display='none';
  $('mode3Settings').style.display='flex';
};

// --- MODE 3 & DUEL DRAWING ---
const stadiumImg = new Image();
stadiumImg.src = 'stadium_bg.PNG';
const M3={canvas:null,ctx:null,W:0,H:0};

function initMode3Canvas(){
  M3.canvas=$('mode3Canvas');
  M3.ctx=M3.canvas.getContext('2d');
  resizeMode3();
  window.addEventListener('resize',resizeMode3);
}

function resizeMode3(){
  M3.W=M3.canvas.width=window.innerWidth;
  M3.H=M3.canvas.height=window.innerHeight;
  drawMode3Scene();
}

function getGoalGeometry(){
  const W=M3.W,H=M3.H,cx=W/2;
  const horizonY=H*0.18, crossbarY=H*0.28, crossbarHalf=W*0.45;
  const postBaseY=H*0.84, goalHeight=postBaseY-crossbarY;
  const postBaseHalf=crossbarHalf - Math.tan(5*Math.PI/180)*goalHeight;
  return {cx, tl:{x:cx-crossbarHalf, y:crossbarY}, tr:{x:cx+crossbarHalf, y:crossbarY}, 
          bl:{x:cx-postBaseHalf, y:postBaseY}, br:{x:cx+postBaseHalf, y:postBaseY}, 
          crossbarY, postBaseY, horizonY};
}

function drawMode3Scene(ballPos, impactDot){
  const ctx=M3.ctx, W=M3.W, H=M3.H, g=getGoalGeometry();
  if (stadiumImg.complete) {
    const scale = Math.max(W/stadiumImg.width, H/stadiumImg.height);
    ctx.drawImage(stadiumImg, (W-stadiumImg.width*scale)/2, (H-stadiumImg.height*scale)/2, stadiumImg.width*scale, stadiumImg.height*scale);
  } else { ctx.fillStyle='#0a0a0f'; ctx.fillRect(0,0,W,H); }

  if(impactDot){
    ctx.fillStyle='rgba(0,229,255,0.5)'; ctx.beginPath(); ctx.arc(impactDot.x,impactDot.y,15,0,Math.PI*2); ctx.fill();
  }
  if(ballPos){
    const sz=ballPos.size||14;
    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(ballPos.x,ballPos.y,sz,0,Math.PI*2); ctx.fill();
  }
}

function getRandomMode3Target(){
  const r=Math.random()*100, {out, side}=mode3Chances;
  if(r<out) return ['OUT_TOP','OUT_LEFT','OUT_RIGHT'][Math.floor(Math.random()*3)];
  if(r<out+side) return Math.random()<0.5?'A':'D';
  return 'W';
}

function animateBallMode3(targetType, onDone){
  const g=getGoalGeometry(), targets=getBallTargets();
  let endPos, thisNeedsSpace=true;
  switch(targetType){
    case 'A':endPos=targets.leftCorner;break;
    case 'D':endPos=targets.rightCorner;break;
    case 'W':endPos=targets.center;break;
    default: endPos=targetType==='OUT_TOP'?targets.overTop:(targetType==='OUT_LEFT'?targets.outLeft:targets.outRight); thisNeedsSpace=false;
  }
  roundNeedsSpace=thisNeedsSpace;
  const startT=performance.now(), duration=700;
  function f(now){
    let t=Math.min((now-startT)/duration, 1);
    const ease=1-Math.pow(1-t,3);
    const x=g.cx+(endPos.x-g.cx)*ease, y=(g.horizonY+20)+(endPos.y-(g.horizonY+20))*ease;
    drawMode3Scene({x,y,size:4+18*ease}, !thisNeedsSpace?endPos:null);
    if(t<1) requestAnimationFrame(f); else if(onDone) onDone();
  }
  requestAnimationFrame(f);
}

function getBallTargets(){
  const g=getGoalGeometry(), cx=g.cx, goalH=g.postBaseY-g.crossbarY, goalW=g.br.x-g.bl.x;
  return {
    leftCorner:{x:g.bl.x+goalW*0.08, y:g.crossbarY+goalH*0.55},
    rightCorner:{x:g.br.x-goalW*0.08, y:g.crossbarY+goalH*0.55},
    center:{x:cx, y:g.crossbarY+goalH*0.45},
    overTop:{x:cx, y:g.crossbarY-40},
    outLeft:{x:g.bl.x-50, y:g.crossbarY+goalH*0.3},
    outRight:{x:g.br.x+50, y:g.crossbarY+goalH*0.3}
  };
}

// --- LOGIC ---
let m3SpacePressed=false, m3TimeoutId=null;

function startRound(){
  if(attempts>=maxAttempts){ (mode===4)?checkDuelEnd():showResults(); return; }
  $('left').classList.remove('active'); $('right').classList.remove('active');
  firstDir=null; firstDirTime=null; spaceTime=null; allKeySegments=[]; allSpacePresses=[];
  
  if(mode>=3){
    drawMode3Scene();
    roundStartTime=performance.now(); recording=true; waiting=false; m3SpacePressed=false;
    setTimeout(()=>{
      target = (mode===4) ? duelSequence[attempts] : getRandomMode3Target();
      signalTime=performance.now(); waiting=true;
      animateBallMode3(target, ()=>{
        if(!roundNeedsSpace) m3TimeoutId=setTimeout(()=>{if(waiting){waiting=false;recording=false;finalizeKeys(performance.now());evaluateMode3();}},1200);
      });
    }, Math.random()*1500+600);
  } else {
    // Mode 1, 2 logic
    roundStartTime=performance.now(); recording=true; waiting=false;
    setTimeout(()=>{
      target=Math.random()<.5?'A':'D'; signalTime=performance.now(); waiting=true;
      if(mode===1) $(target==='A'?'left':'right').classList.add('active');
      if(mode===2){$('ball').style.display='block'; $('ball').style.left='50%'; $('ball').style.top='0%';
        requestAnimationFrame(()=>{ $('ball').style.transition='all 0.35s linear'; $('ball').style.left=target==='A'?'20%':'80%'; $('ball').style.top='80%'; });}
    }, Math.random()*1500+500);
  }
}

document.addEventListener('keydown',e=>{
  if(!recording || e.repeat)return;
  const now=performance.now(), code=e.code;
  if((code==='KeyA'||code==='KeyD'||(code==='KeyW'&&mode>=3))&&!allKeyDowns[code]){
    allKeyDowns[code]=now;
    if(!firstDir&&waiting){ firstDir=code.replace('Key',''); firstDirTime=now; }
  }
  if(code==='Space'){
    allSpacePresses.push(now);
    if(mode>=3&&waiting){
      spaceTime=now; m3SpacePressed=true; waiting=false; recording=false;
      if(!firstDir){ if(allKeyDowns['KeyA']){firstDir='A';firstDirTime=allKeyDowns['KeyA']}else if(allKeyDowns['KeyD']){firstDir='D';firstDirTime=allKeyDowns['KeyD']}else if(allKeyDowns['KeyW']){firstDir='W';firstDirTime=allKeyDowns['KeyW']} }
      if(m3TimeoutId)clearTimeout(m3TimeoutId); finalizeKeys(now); evaluateMode3();
    } else if(waiting&&!spaceTime){
      spaceTime=now; waiting=false; recording=false;
      if(!firstDir){ if(allKeyDowns['KeyA']){firstDir='A';firstDirTime=allKeyDowns['KeyA']}else if(allKeyDowns['KeyD']){firstDir='D';firstDirTime=allKeyDowns['KeyD']} }
      finalizeKeys(now); evaluate();
    }
  }
});

document.addEventListener('keyup',e=>{ if(allKeyDowns[e.code]){allKeySegments.push({code:e.code,down:allKeyDowns[e.code],up:performance.now()});delete allKeyDowns[e.code];} });

function finalizeKeys(endTime){ Object.keys(allKeyDowns).forEach(c=>{allKeySegments.push({code:c,down:allKeyDowns[c],up:endTime});delete allKeyDowns[c];}); }

function evaluateMode3(){
  let ok=false, reaction=spaceTime?Math.round(spaceTime-signalTime):null, result;
  if(!roundNeedsSpace){ if(m3SpacePressed) result='Мимо — не прыгай!'; else {ok=true; result='Мимо — верно!'} }
  else {
    if(!m3SpacePressed) result='Не прыгнул!'; else if(!firstDir) result='Без направления';
    else if(spaceTime+tolerance<firstDirTime) result='Рано прыгнул'; else if(firstDir!==target) result='Неверно';
    else {ok=true; if(reaction)reactions.push(reaction); result=`${reaction} мс`}
  }
  updateHudAndData(ok, result, reaction);
}

function evaluate(){
  let ok=false, reaction=Math.round(spaceTime-signalTime), result;
  if(!firstDir) result='Без направления'; else if(spaceTime+tolerance<firstDirTime) result='Рано прыгнул';
  else if(firstDir!==target) result='Неверно'; else {ok=true; reactions.push(reaction); result=`${reaction} мс`}
  updateHudAndData(ok, result, reaction);
}

function updateHudAndData(ok, result, reactionMs){
  const dot=$('dot'+attempts); if(dot) dot.classList.add(ok?'success':'fail');
  roundData.push({attempt:attempts+1, target, firstDir, ok, result, reactionMs, signalRel:signalTime-roundStartTime, spaceRel:spaceTime?spaceTime-roundStartTime:null, allSpaceRel:allSpacePresses.map(t=>t-roundStartTime), segments:allKeySegments.map(s=>({code:s.code,down:s.down-roundStartTime,up:s.up-roundStartTime}))});
  attempts++; $('info').textContent=(ok?'✅ ':'❌ ')+result;
  if(mode===4 && attempts === 15) conn.send({type: 'GAME_OVER', results: roundData});
  setTimeout(startRound, 900);
}

// --- RESULTS & DUEL END ---
function checkDuelEnd(){
  if(roundData.length >= 15 && opponentResults) showDuelResults();
  else $('info').textContent = "Ожидание соперника...";
}

function showDuelResults(){
  let p1=0, p2=0, html='<div class="res-title">РЕЗУЛЬТАТЫ ДУЭЛИ</div><div class="res-avg">Сравнение по раундам</div>';
  for(let i=0; i<15; i++){
    const m=roundData[i], o=opponentResults[i], mt=m.reactionMs||9999, ot=o.reactionMs||9999;
    let resText='Ничья', color='var(--border)';
    if(m.ok && (!o.ok || mt < ot)){ p1++; resText='Вы +1'; color='rgba(0,230,118,0.1)'; }
    else if(o.ok && (!m.ok || ot < mt)){ p2++; resText='Друг +1'; color='rgba(255,61,113,0.1)'; }
    html+=`<div class="round-card" style="background:${color};padding:10px;margin-bottom:5px;font-size:14px"><b>Р${i+1}:</b> Вы: ${m.result} | Друг: ${o.result} — <i>${resText}</i></div>`;
  }
  const win = p1>p2?"ПОБЕДА":(p1<p2?"ПОРАЖЕНИЕ":"НИЧЬЯ");
  html=`<div class="res-title" style="color:var(--accent)">${win}</div><div class="res-avg" style="font-size:40px">${p1} : ${p2}</div>` + html;
  html+=`<div class="btn-row"><button class="restart-btn" onclick="location.href=window.location.pathname">В меню</button></div>`;
  $('resultsOverlay').classList.add('show'); $('resultsContent').innerHTML=html;
}

function showResults(){
  $('resultsOverlay').classList.add('show');
  let avg=reactions.length?Math.round(reactions.reduce((a,b)=>a+b,0)/reactions.length)+' мс':'—';
  let html=`<div class="res-title">Результаты</div><div class="res-avg">Средняя реакция: ${avg}</div>`;
  html+=`<div class="btn-row"><button class="restart-btn" onclick="restartSameMode()">Снова</button><button class="back-btn" onclick="backToMenu()">В меню</button></div>`;
  $('resultsContent').innerHTML=html;
}

window.restartSameMode=()=>startGame(mode);
window.backToMenu=()=>{resetGame(); $('mode3Area').style.display='none'; $('gameArea').style.display='flex'; $('menu').style.display='flex';};

// --- SETTINGS ---
const outR=$('outRange'), sideR=$('sideRange'), centerR=$('centerRange');
function updatePercents(){
  let o=+outR.value, s=+sideR.value, c=+centerR.value, sum=o+s+c||1;
  o=Math.round(o/sum*100); s=Math.round(s/sum*100); c=100-o-s;
  $('pOut').textContent=o; $('pSide').textContent=s; $('pCenter').textContent=c;
  mode3Chances={out:o, side:s, center:c};
}
[outR,sideR,centerR].forEach(r=>r.oninput=updatePercents);
$('startMode3').onclick=()=>{ $('mode3Settings').style.display='none'; startGame(3); };
updatePercents();
</script>
</body>
</html>

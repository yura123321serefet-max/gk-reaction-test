<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GK Duel 3D - Ultimate Fix</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{--accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f;--border:#1e1e2e;--success:#00e676;--fail:#ff3d71;}
#menu, #lobby, #resultsOverlay, #waitingScreen, #setupMenu {position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:1000;}
#setupMenu, #lobby, #waitingScreen, #resultsOverlay { display: none; }
h1 { font-size:36px; font-weight:900; background:linear-gradient(135deg,var(--accent),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.menu-btn {padding:14px 28px;font-size:16px;font-weight:700;border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff;cursor:pointer;transition:all .2s;min-width:260px; text-align:center;}
.menu-btn:hover{border-color:var(--accent);transform:translateY(-2px)}
.settings-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:32px; width:400px; max-width:90vw; }
.slider-row { margin-bottom: 20px; }
.slider-row label { display:flex; justify-content:space-between; margin-bottom:8px; font-size:14px; color:#aaa; }
.slider-row b { color: var(--accent); }
input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); }
#mode3Area { position:fixed; inset:0; display:none; overflow:hidden; z-index:40; }
#mode3Canvas { width:100%; height:100%; display:block; }
#hud { position:fixed; top:16px; left:50%; transform:translateX(-50%); display:flex; gap:6px; z-index:50; }
.dot { width:12px; height:12px; border-radius:50%; border:2px solid #333; }
.dot.success { background:var(--success); border-color:var(--success); box-shadow:0 0 8px var(--success); }
.dot.fail { background:var(--fail); border-color:var(--fail); box-shadow:0 0 8px var(--fail); }
.dot.current { border-color:var(--accent); box-shadow:0 0 8px var(--accent); }
input[type="text"] { padding:10px; border-radius:8px; border:1px solid var(--border); background:#1a1a2e; color:#fff; text-align:center; width:220px; }
</style>
</head>
<body>

<div id="menu">
    <h1>GK DUEL 3D</h1>
    <button class="menu-btn" onclick="openSetup()">Создать дуэль</button>
    <button class="menu-btn" onclick="showLobby('join')">Войти по ID</button>
</div>

<div id="setupMenu">
    <div class="settings-card">
        <h2 style="margin-bottom:20px; text-align:center">Настройка ударов</h2>
        <div class="slider-row"><label>Мимо ворот: <b><span id="vOut">30</span>%</b></label><input type="range" id="rOut" min="0" max="100" value="30"></div>
        <div class="slider-row"><label>В створ (углы): <b><span id="vSide">50</span>%</b></label><input type="range" id="rSide" min="0" max="100" value="50"></div>
        <div class="slider-row"><label>По центру: <b><span id="vCenter">20</span>%</b></label><input type="range" id="rCenter" min="0" max="100" value="20"></div>
        <button class="menu-btn" style="width:100%; margin-top:10px" onclick="showLobby('create')">ГОТОВО</button>
    </div>
</div>

<div id="lobby">
    <h2 id="statusTitle">Инициализация...</h2>
    <div id="idArea" style="display:none">
        <input type="text" id="myId" readonly onclick="this.select()">
        <p style="font-size:12px; color:#555; margin-top:10px">ID готов! Отправь его другу.</p>
    </div>
    <div id="joinArea" style="display:none">
        <input type="text" id="peerIdInput" placeholder="Вставь ID друга">
        <button class="menu-btn" style="margin-top:15px" onclick="connectToPeer()">Начать игру</button>
    </div>
</div>

<div id="mode3Area">
    <div id="hud"></div>
    <canvas id="mode3Canvas"></canvas>
    <div id="info" style="position:fixed; bottom:20px; width:100%; text-align:center; font-weight:bold; font-size:24px; pointer-events:none; z-index:60;"></div>
</div>

<div id="waitingScreen"><h1>ОЖИДАНИЕ...</h1></div>
<div id="resultsOverlay"><div id="finalScore" style="font-size:40px"></div><button class="menu-btn" onclick="location.reload()">В МЕНЮ</button></div>

<script>
let peer, conn, isHost = false;
let chances = { out: 30, side: 50, center: 20 };
let currentRound = 0, MAX_ROUNDS = 15, sequence = [], myResults = [], opponentResults = [];
let signalTime = 0, waiting = false, firstDir = null, spaceTime = null;

function openSetup() { document.getElementById('menu').style.display = 'none'; document.getElementById('setupMenu').style.display = 'flex'; }

const rOut = document.getElementById('rOut'), rSide = document.getElementById('rSide'), rCenter = document.getElementById('rCenter');
function updatePercents() {
    let o = +rOut.value, s = +rSide.value, c = +rCenter.value, sum = o + s + c || 1;
    o = Math.round(o/sum*100); s = Math.round(s/sum*100); c = 100-o-s;
    document.getElementById('vOut').textContent = o; document.getElementById('vSide').textContent = s; document.getElementById('vCenter').textContent = c;
    chances = { out: o, side: s, center: c };
}
[rOut, rSide, rCenter].forEach(r => r.addEventListener('input', updatePercents));

// --- ПУЛ СЕРВЕРОВ ДЛЯ ОБХОДА БЛОКИРОВОК ---
function initPeer(mode) {
    const config = {
        debug: 2,
        config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }]}
    };

    peer = new Peer(undefined, config);

    peer.on('open', id => {
        document.getElementById('statusTitle').innerText = mode === 'create' ? "ВАШ ID:" : "ВВЕДИТЕ ID ДРУГА:";
        document.getElementById('myId').value = id;
        if(mode === 'create') { isHost = true; document.getElementById('idArea').style.display = 'block'; }
        else document.getElementById('joinArea').style.display = 'block';
    });

    peer.on('error', err => {
        console.error("PeerJS Error:", err.type);
        document.getElementById('statusTitle').innerHTML = `<span style="color:red">Ошибка сервера. Пробуем другой...</span>`;
        // Если первый сервер не сработал, через 3 секунды пробуем запасной
        setTimeout(() => { if(!peer.id) location.reload(); }, 3000);
    });

    peer.on('connection', c => { conn = c; setupConn(); });
}

function showLobby(mode) {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('setupMenu').style.display = 'none';
    document.getElementById('lobby').style.display = 'flex';
    initPeer(mode);
}

function connectToPeer() {
    const id = document.getElementById('peerIdInput').value.trim();
    if(id) { conn = peer.connect(id); setupConn(); }
}

function setupConn() {
    conn.on('open', () => {
        if(isHost) {
            sequence = [];
            for(let i=0; i<MAX_ROUNDS; i++) {
                let r = Math.random()*100;
                if(r < chances.out) sequence.push(['OUT_TOP','OUT_LEFT','OUT_RIGHT'][Math.floor(Math.random()*3)]);
                else if(r < chances.out + chances.side) sequence.push(Math.random()<0.5?'A':'D');
                else sequence.push('W');
            }
            conn.send({ type: 'START', sequence });
            startDuel();
        }
    });
    conn.on('data', data => {
        if(data.type === 'START') { sequence = data.sequence; startDuel(); }
        if(data.type === 'RESULTS') { opponentResults = data.res; checkFinal(); }
    });
}

// --- УПРОЩЕННЫЙ ДВИЖОК ИГРЫ ---
const M3 = { ctx: null, W: 0, H: 0 };
function startDuel() {
    document.getElementById('lobby').style.display = 'none';
    document.getElementById('mode3Area').style.display = 'block';
    const canvas = document.getElementById('mode3Canvas');
    M3.ctx = canvas.getContext('2d');
    M3.W = canvas.width = window.innerWidth;
    M3.H = canvas.height = window.innerHeight;
    
    let h = ''; for(let i=0; i<MAX_ROUNDS; i++) h += `<div class="dot" id="dot${i}"></div>`;
    document.getElementById('hud').innerHTML = h;
    nextRound();
}

function nextRound() {
    if(currentRound >= MAX_ROUNDS) {
        document.getElementById('waitingScreen').style.display = 'flex';
        conn.send({ type: 'RESULTS', res: myResults });
        checkFinal(); return;
    }
    document.getElementById('dot'+currentRound).classList.add('current');
    waiting = false;
    setTimeout(() => { signalTime = performance.now(); waiting = true; renderRound(); }, 1000 + Math.random()*1500);
}

function renderRound() {
    const target = sequence[currentRound];
    const isOut = target.startsWith('OUT');
    document.getElementById('info').innerText = isOut ? "МИМО!" : "УДАР!";
    
    if(isOut) {
        setTimeout(() => { if(waiting) resolveRound(true); }, 800);
    }
}

function resolveRound(auto) {
    if(!waiting) return; waiting = false;
    const target = sequence[currentRound];
    const isOut = target.startsWith('OUT');
    let ok = isOut ? auto : (!auto && firstDir === target);
    
    myResults.push({ ok, rt: ok && !isOut ? (spaceTime - signalTime) : 999 });
    document.getElementById('dot'+currentRound).className = 'dot ' + (ok?'success':'fail');
    currentRound++;
    document.getElementById('info').innerText = "";
    firstDir = null;
    setTimeout(nextRound, 800);
}

window.onkeydown = e => {
    if(!waiting || e.repeat) return;
    if(['KeyA','KeyW','KeyD'].includes(e.code)) firstDir = e.code.replace('Key','');
    if(e.code === 'Space') { spaceTime = performance.now(); resolveRound(false); }
};

function checkFinal() {
    if(myResults.length < MAX_ROUNDS || opponentResults.length < MAX_ROUNDS) return;
    document.getElementById('mode3Area').style.display = 'none';
    document.getElementById('waitingScreen').style.display = 'none';
    document.getElementById('resultsOverlay').style.display = 'flex';
    let myS = myResults.filter(r => r.ok).length;
    let oppS = opponentResults.filter(r => r.ok).length;
    document.getElementById('finalScore').innerText = `ИТОГ: ${myS} - ${oppS}`;
}
</script>
</body>
</html>

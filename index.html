<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rematch GK Reaction Test - Duel</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Outfit',sans-serif;height:100vh;overflow:hidden;display:flex;flex-direction:column}
:root{
  --accent:#00e5ff;--purple:#7c4dff;--bg:#0a0a0f;--card:#14141f;
  --border:#1e1e2e;--success:#00e676;--fail:#ff3d71;--warn:#ffab00;
}

#menu{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:1000}
#menu h1{font-size:42px;font-weight:900;letter-spacing:-1px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.menu-btn{
  padding:16px 36px;font-size:18px;font-family:'Outfit',sans-serif;font-weight:700;
  border:2px solid var(--border);border-radius:12px;background:var(--card);color:#fff;
  cursor:pointer;transition:all .2s;min-width:300px;
}
.menu-btn:hover{border-color:var(--accent);box-shadow:0 0 24px rgba(0,229,255,.15);transform:translateY(-2px)}
.menu-btn span{color:#888;font-weight:300;font-size:13px;display:block;margin-top:4px}

#gameArea{flex:1;display:flex;position:relative;overflow:hidden}
.side{flex:1;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;font-family:'JetBrains Mono',monospace;opacity:.06;transition:all .15s;user-select:none}
#ball{position:absolute;width:36px;height:36px;border-radius:50%;background:#fff;left:50%;top:0%;transform:translate(-50%,0%);display:none;z-index:10}

#hud{position:fixed;top:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:50}
.dot{width:14px;height:14px;border-radius:50%;border:2px solid #333}
.dot.success{background:var(--success);border-color:var(--success)}
.dot.fail{background:var(--fail);border-color:var(--fail)}
.dot.current{border-color:var(--accent)}

#info{position:fixed;bottom:16px;width:100%;text-align:center;font-size:16px;font-family:'JetBrains Mono',monospace;color:#888;z-index:50}

#mode3Area{position:fixed;inset:0;display:none;z-index:40}
#mode3Canvas{width:100%;height:100%}

#duelOverlay{position:fixed;inset:0;background:rgba(10,10,15,0.98);z-index:3000;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
#duelLinkInput{width:320px;padding:12px;background:#000;border:1px solid var(--accent);color:#fff;border-radius:8px;text-align:center;margin:15px 0;font-family:monospace}
#duelScoreHUD{position:fixed;top:45px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:18px;z-index:100;background:rgba(0,0,0,0.6);padding:6px 20px;border-radius:20px;display:none;border:1px solid var(--border)}

#resultsOverlay{position:fixed;inset:0;background:rgba(10,10,15,.97);z-index:2000;display:none;flex-direction:column;align-items:center;padding:40px 20px;overflow-y:auto}
.res-title{font-size:36px;font-weight:900;margin-bottom:20px}
</style>
</head>
<body>

<div id="menu">
  <h1>GK Reaction Test</h1>
  <button class="menu-btn" onclick="startGame(1)">–†–µ–∂–∏–º 1 ‚Äî –°–∏–≥–Ω–∞–ª</button>
  <button class="menu-btn" onclick="startGame(2)">–†–µ–∂–∏–º 2 ‚Äî –ú—è—á</button>
  <button class="menu-btn" id="mode3btn">–†–µ–∂–∏–º 3 ‚Äî 3D –í–æ—Ä–æ—Ç–∞</button>
  <button class="menu-btn" id="duelBtn" style="border-color:var(--purple)">–†–ï–ñ–ò–ú –î–£–≠–õ–¨<span>1 –Ω–∞ 1 –ø—Ä–æ—Ç–∏–≤ –¥—Ä—É–≥–∞</span></button>
</div>

<div id="duelOverlay">
  <h2 id="duelStatus">–°–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</h2>
  <div id="duelLinkContainer" style="display:none">
    <p>–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</p>
    <input type="text" id="duelLinkInput" readonly>
    <br>
    <button class="menu-btn" style="min-width:auto" onclick="copyDuelLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
  </div>
</div>

<div id="duelScoreHUD">–Ø: 0 | –î—Ä—É–≥: 0</div>
<div id="hud"></div>
<div id="gameArea">
  <div id="left" class="side">A</div>
  <div id="right" class="side">D</div>
  <div id="ball"></div>
</div>
<div id="info"></div>
<div id="mode3Area"><canvas id="mode3Canvas"></canvas></div>
<div id="resultsOverlay"><div id="resultsContent" style="width:100%;max-width:600px;text-align:center"></div></div>

<script>
const $=id=>document.getElementById(id);
let mode=1, attempts=0, maxAttempts=5;
let target=null, signalTime=0, waiting=false, recording=false;
let roundStartTime=0, firstDir=null, firstDirTime=null, spaceTime=null;
let allKeyDowns={}, allKeySegments=[], allSpacePresses=[], reactions=[];
let roundNeedsSpace=false, m3SpacePressed=false;

// PeerJS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let peer, conn, isDuel=false, isHost=false;
let duelTargets=[], myResults=[], oppResults=[], myPoints=0, oppPoints=0;

const stadiumImg = new Image();
stadiumImg.src = 'stadium_bg.PNG'; 

const M3={canvas:null,ctx:null,W:0,H:0};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('join');
    if(joinId) {
        isDuel = true;
        initPeer(joinId);
    }
};

$('mode3btn').onclick=()=>startGame(3);
$('duelBtn').onclick=()=>{ isDuel=true; isHost=true; initPeer(); };

function initPeer(joinId = null) {
    $('menu').style.display = 'none';
    $('duelOverlay').style.display = 'flex';
    peer = new Peer();

    peer.on('open', (id) => {
        if(joinId) {
            $('duelStatus').textContent = "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –¥—Ä—É–≥—É...";
            conn = peer.connect(joinId);
            setupConn();
        } else {
            const link = window.location.origin + window.location.pathname + "?join=" + id;
            $('duelLinkInput').value = link;
            $('duelLinkContainer').style.display = 'block';
            $('duelStatus').textContent = "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...";
        }
    });

    peer.on('connection', (c) => {
        conn = c;
        setupConn();
        if(isHost) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 15 —Ä–∞—É–Ω–¥–æ–≤
            duelTargets = [];
            for(let i=0; i<15; i++) {
                const r = Math.random()*100;
                if(r<30) duelTargets.push('OUT');
                else if(r<80) duelTargets.push(Math.random()<0.5?'A':'D');
                else duelTargets.push('W');
            }
            // –ú–∞–ª–µ–Ω—å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –∫–∞–Ω–∞–ª –ø—Ä–æ—Å–Ω—É–ª—Å—è
            setTimeout(() => {
                conn.send({type:'START', targets: duelTargets});
                startDuelGame();
            }, 800);
        }
    });
}

function setupConn() {
    conn.on('data', (data) => {
        if(data.type === 'START') {
            duelTargets = data.targets;
            startDuelGame();
        }
        if(data.type === 'RESULT') {
            oppResults[data.round] = data.res;
            calculateDuelScore();
        }
    });
}

function startDuelGame() {
    isDuel = true;
    mode = 3; 
    maxAttempts = 15;
    $('duelOverlay').style.display = 'none';
    $('duelScoreHUD').style.display = 'block';
    $('menu').style.display = 'none';
    $('gameArea').style.display = 'none';
    $('mode3Area').style.display = 'block';
    initMode3Canvas();
    resetGame();
    startRound();
}

function calculateDuelScore() {
    myPoints = 0; oppPoints = 0;
    for(let i=0; i<15; i++) {
        let me = myResults[i], op = oppResults[i];
        if(!me || !op) continue;
        if(me.ok && !op.ok) myPoints++;
        else if(!me.ok && op.ok) oppPoints++;
        else if(me.ok && op.ok) {
            if(me.reaction < op.reaction) myPoints++;
            else if(me.reaction > op.reaction) oppPoints++;
        }
    }
    $('duelScoreHUD').textContent = `–Ø: ${myPoints} | –î—Ä—É–≥: ${oppPoints}`;
}

function startGame(m) {
    mode = m;
    maxAttempts = (mode===3) ? 15 : 5;
    $('menu').style.display = 'none';
    if(mode===3) {
        $('gameArea').style.display = 'none';
        $('mode3Area').style.display = 'block';
        initMode3Canvas();
    }
    resetGame();
    startRound();
}

function resetGame() {
    attempts = 0; myResults = []; oppResults = []; reactions = [];
    $('hud').innerHTML = ''; buildHud();
    $('resultsOverlay').style.display = 'none';
}

function buildHud() {
    for(let i=0; i<maxAttempts; i++) {
        let d = document.createElement('div');
        d.className = 'dot'; d.id = 'dot'+i;
        $('hud').appendChild(d);
    }
}

function startRound() {
    if(attempts >= maxAttempts) { showResults(); return; }
    
    recording = true; waiting = false; m3SpacePressed = false;
    firstDir = null; spaceTime = null;
    $('info').textContent = "–ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è...";
    
    // –í 3D —Ä–µ–∂–∏–º–µ —Ä–∏—Å—É–µ–º –ø–æ–ª–µ —Å—Ä–∞–∑—É
    if(mode===3) { drawMode3Scene({x:M3.W/2, y:M3.H*0.2, size:6}); }

    setTimeout(() => {
        target = isDuel ? duelTargets[attempts] : (Math.random()<0.5?'A':'D');
        if(mode===3 && !isDuel) {
             const r = Math.random()*100;
             target = r<30?'OUT':(r<80?(Math.random()<0.5?'A':'D'):'W');
        }
        
        signalTime = performance.now();
        waiting = true;
        $('info').textContent = "–†–ê–ë–û–¢–ê–ô!";
        
        if(mode===3) {
            roundNeedsSpace = (target !== 'OUT');
            animateBall3D(target);
        } else {
            $(target==='A'?'left':'right').style.opacity = "1";
        }
    }, 1000 + Math.random()*1500);
}

function animateBall3D(tType) {
    const startT = performance.now();
    const duration = 700;
    const g = { cx: M3.W/2, cy: M3.H*0.2, endY: M3.H*0.6 };
    let endX = g.cx;
    if(tType==='A') endX = g.cx - M3.W*0.3;
    if(tType==='D') endX = g.cx + M3.W*0.3;
    if(tType==='OUT') endX = g.cx + (Math.random()-0.5)*M3.W*0.8;

    function frame(now) {
        let t = Math.min((now - startT)/duration, 1);
        let ease = t*t;
        let x = g.cx + (endX - g.cx)*ease;
        let y = g.cy + (g.endY - g.cy)*ease;
        drawMode3Scene({x, y, size: 6 + 20*ease});
        if(t < 1 && waiting) requestAnimationFrame(frame);
        else if(t >= 1 && !roundNeedsSpace) { 
            setTimeout(() => { if(waiting) finishRound(false); }, 500); 
        }
    }
    requestAnimationFrame(frame);
}

function finishRound(wasJumped) {
    if(!waiting) return;
    waiting = false; recording = false;
    
    let ok = false;
    const reaction = spaceTime ? Math.round(spaceTime - signalTime) : 9999;
    
    if(roundNeedsSpace) {
        if(wasJumped && firstDir === target) ok = true;
    } else {
        if(!wasJumped) ok = true;
    }

    if(ok && reaction !== 9999) reactions.push(reaction);
    
    const dot = $('dot'+attempts);
    if(dot) dot.className = 'dot ' + (ok?'success':'fail');

    if(isDuel) {
        myResults[attempts] = {ok, reaction};
        conn.send({type:'RESULT', round: attempts, res: myResults[attempts]});
        calculateDuelScore();
    }

    $('info').textContent = ok ? "‚úÖ –ü–†–ò–ù–Ø–¢–û!" : "‚ùå –û–®–ò–ë–ö–ê";
    attempts++;
    setTimeout(startRound, 1200);
}

document.addEventListener('keydown', e => {
    if(!recording || e.repeat) return;
    if(e.code === 'KeyA') firstDir = 'A';
    if(e.code === 'KeyD') firstDir = 'D';
    if(e.code === 'KeyW') firstDir = 'W';
    
    if(e.code === 'Space' && waiting) {
        spaceTime = performance.now();
        finishRound(true);
    }
});

function initMode3Canvas() {
    M3.canvas = $('mode3Canvas');
    M3.ctx = M3.canvas.getContext('2d');
    M3.W = window.innerWidth; M3.H = window.innerHeight;
    M3.canvas.width = M3.W; M3.canvas.height = M3.H;
}

function drawMode3Scene(ball) {
    const ctx = M3.ctx;
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect(0,0,M3.W,M3.H);
    
    // –†–∏—Å—É–µ–º "–≤–æ—Ä–æ—Ç–∞" (–ø—Ä–æ—Å—Ç–∞—è —Ä–∞–º–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 5;
    ctx.strokeRect(M3.W*0.15, M3.H*0.2, M3.W*0.7, M3.H*0.6);
    
    if(ball) {
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI*2); ctx.fill();
    }
}

function showResults() {
    $('mode3Area').style.display = 'none';
    $('duelScoreHUD').style.display = 'none';
    $('resultsOverlay').style.display = 'flex';
    
    let title = "–ö–æ–Ω–µ—Ü —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏";
    if(isDuel) {
        title = myPoints > oppPoints ? "–¢–´ –í–´–ò–ì–†–ê–õ! üèÜ" : (myPoints < oppPoints ? "–î–†–£–ì –í–´–ò–ì–†–ê–õ üíÄ" : "–ù–ò–ß–¨–Ø ü§ù");
    }
    
    $('resultsContent').innerHTML = `
        <h1 class="res-title">${title}</h1>
        <p style="font-size:24px">${isDuel ? `–°—á–µ—Ç: ${myPoints} ‚Äî ${oppPoints}` : ''}</p>
        <button class="menu-btn" onclick="location.href=location.pathname" style="margin-top:30px">–í –º–µ–Ω—é</button>
    `;
}

function copyDuelLink() {
    $('duelLinkInput').select();
    document.execCommand('copy');
    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
}
</script>
</body>
</html>
